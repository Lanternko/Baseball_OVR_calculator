<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研究模式 - 棒球 OVR 計算器</title>
    <link rel="stylesheet" href="../src/css/style.css">
    <link rel="stylesheet" href="../src/css/player-cards.css">
    <link rel="stylesheet" href="../src/css/modal.css">
    <style>
        /* ================================== */
        /* 研究模式擴展樣式 */
        /* ================================== */
        
        /* 頁面佈局 */
        .research-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        /* 測試區塊 */
        .test-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            margin: var(--spacing-2xl) 0;
            overflow: hidden;
            border: 1px solid #E5E5E5;
        }
        
        .test-section-header {
            background: var(--bg-surface);
            border-bottom: 1px solid #E5E5E5;
            padding: var(--spacing-lg);
        }
        
        .test-section-header h2 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--text-primary);
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .test-section-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .test-section-content {
            padding: var(--spacing-xl);
        }
        
        /* 控制面板 */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }
        
        .control-group {
            background: var(--bg-card);
            border: 1px solid #E5E5E5;
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
        }
        
        .control-group h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
        }
        
        /* 屬性選擇器 */
        .attribute-selector {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .attribute-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid #E5E5E5;
            background: var(--bg-surface);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 80px;
            text-align: center;
        }
        
        .attribute-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .attribute-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        /* 快速測試按鈕 */
        .quick-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .quick-test-btn {
            padding: var(--spacing-md);
            background: var(--bg-surface);
            border: 1px solid #E5E5E5;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .quick-test-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
        }
        
        .quick-test-btn h4 {
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--text-primary);
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .quick-test-btn p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.8em;
        }
        
        /* 結果顯示 */
        .results-container {
            background: var(--bg-surface);
            border: 1px solid #E5E5E5;
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        .results-table th,
        .results-table td {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid #E5E5E5;
            text-align: center;
        }
        
        .results-table th {
            background: var(--bg-header);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .results-table tbody tr:nth-child(even) {
            background: #FAFAFA;
        }
        
        .results-table tbody tr:hover {
            background: var(--accent-light);
        }
        
        /* 狀態指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-excellent .status-dot { background: var(--success); }
        .status-good .status-dot { background: var(--info); }
        .status-fair .status-dot { background: var(--warning); }
        .status-poor .status-dot { background: var(--error); }
        
        /* 載入狀態 */
        .loading-indicator {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--text-secondary);
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-light);
            border-radius: 50%;
            border-top: 2px solid var(--accent-primary);
            animation: spin 1s linear infinite;
            margin-right: var(--spacing-sm);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .research-container {
                padding: var(--spacing-md);
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .attribute-selector {
                flex-direction: column;
            }
            
            .quick-test-grid {
                grid-template-columns: 1fr;
            }
            
            .results-table {
                font-size: 0.75em;
            }
        }
        
        /* 高亮行 */
        .highlight-row {
            background: var(--accent-light) !important;
            border: 2px solid var(--accent-primary) !important;
        }
        
        .highlight-row td {
            font-weight: 600;
            color: var(--accent-secondary);
        }
        
        /* 主頁按鈕 */
        .header-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid #E5E5E5;
            background: var(--bg-surface);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            margin-right: var(--spacing-sm);
        }
        
        .header-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: var(--accent-light);
        }
        
        /* 主頁圖標樣式 */
        .home-btn {
            background: transparent;
            border: none;
            padding: var(--spacing-sm);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: all 0.2s ease;
        }
        
        .home-btn:hover {
            background: rgba(128, 128, 128, 0.1);
            transform: scale(1.1);
        }
        
        .home-btn:active {
            transform: scale(0.95);
        }
        
        .home-icon {
            width: 20px;
            height: 20px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .home-btn:hover .home-icon {
            opacity: 1;
        }
        
        /* 深色模式下的圖標處理 */
        [data-theme="dark"] .home-icon {
            filter: invert(1);
        }
        
        /* 移除研究模式中的標籤分隔線 */
        .tab-buttons::after {
            display: none;
        }
        
    </style>
</head>
<body>
    <!-- 使用主頁面相同的頭部設計 -->
    <div class="header">
        <div class="header-content">
            <h1 class="full-title">研究模式</h1>
            <h1 class="mobile-title">研究模式</h1>
            <p>深度數據分析與模型探索工具</p>
            <div class="header-buttons">
                <button class="header-btn home-btn" onclick="goToMainPage()" title="返回主頁">
                    <img src="../src/icons/home.png" alt="返回主頁" class="home-icon">
                </button>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="切換深淺模式">
                    ◐
                </button>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" id="tabAnalysis" onclick="switchTab('analysis')">
                    屬性分析
                </button>
                <button class="tab-btn" id="tabValidation" onclick="switchTab('validation')">
                    模型驗證
                </button>
                <button class="tab-btn" id="tabIsolation" onclick="switchTab('isolation')">
                    屬性隔離
                </button>
                <button class="tab-btn" id="tabComparison" onclick="switchTab('comparison')">
                    真實對比
                </button>
            </div>
        </div>
    </div>

    <div class="research-container">
        <!-- 屬性分析標籤 -->
        <div id="analysis" class="tab-content active">
            <!-- 快速測試面板 -->
            <div class="test-section">
                <div class="test-section-header">
                    <h2>⭐ 核心統計測試</h2>
                    <p>測試關鍵等級 (40/70/100/120/150) 統計準確性 - 高精度模擬</p>
                </div>
                <div class="test-section-content">
                    <div class="quick-test-grid">
                        <div class="quick-test-btn" onclick="runEssentialTest()">
                            <h4>🎯 核心等級測試</h4>
                            <p>驗證 5 個關鍵能力等級的統計準確性</p>
                        </div>
                        <div class="quick-test-btn" onclick="runPerformanceTest()">
                            <h4>⚡ 性能基準測試</h4>
                            <p>評估模型執行速度和穩定性</p>
                        </div>
                        <div class="quick-test-btn" onclick="runRangeValidationTest()">
                            <h4>📊 範圍驗證測試</h4>
                            <p>確認統計數據在合理範圍內</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 結果顯示區域 -->
            <div id="analysisResults"></div>
        </div>

        <!-- 屬性隔離標籤 -->
        <div id="isolation" class="tab-content" style="display: none;">
            <!-- 屬性分析控制台 -->
            <div class="test-section">
                <div class="test-section-header">
                    <h2>🔍 屬性隔離分析</h2>
                    <p>選擇單一屬性進行深度分析，其他屬性保持固定，觀察該屬性對統計數據的獨立影響</p>
                </div>
                <div class="test-section-content">
                    <div class="control-panel">
                        <div class="control-group">
                            <h3>屬性選擇</h3>
                            <div class="attribute-selector">
                                <button class="attribute-btn active" data-attr="pow" onclick="selectAttribute('pow')">
                                    💪 POW
                                </button>
                                <button class="attribute-btn" data-attr="hit" onclick="selectAttribute('hit')">
                                    🎯 HIT
                                </button>
                                <button class="attribute-btn" data-attr="eye" onclick="selectAttribute('eye')">
                                    👁️ EYE
                                </button>
                            </div>
                        </div>
                        <div class="control-group">
                            <h3>測試環境</h3>
                            <div class="attribute-selector">
                                <button class="attribute-btn" onclick="runAttributeAnalysis('bottom')">
                                    底線 (40/40)
                                </button>
                                <button class="attribute-btn active" onclick="runAttributeAnalysis('standard')">
                                    標準 (70/70)
                                </button>
                                <button class="attribute-btn" onclick="runAttributeAnalysis('elite')">
                                    頂線 (100/100)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 結果顯示區域 -->
            <div id="isolationResults"></div>
        </div>

        <!-- 模型驗證標籤 -->
        <div id="validation" class="tab-content" style="display: none;">
            <div class="test-section">
                <div class="test-section-header">
                    <h2>🔄 雙向轉換驗證</h2>
                    <p>驗證屬性與數據間的雙向轉換準確性</p>
                </div>
                <div class="test-section-content">
                    <div class="quick-test-grid">
                        <div class="quick-test-btn" onclick="runPrecisionTest()">
                            <h4>🎯 精確度測試</h4>
                            <p>驗證 100/100/100 組合精確性</p>
                        </div>
                        <div class="quick-test-btn" onclick="runBalanceTest()">
                            <h4>⚖️ 平衡性檢查</h4>
                            <p>檢查極端數值下的穩定性</p>
                        </div>
                        <div class="quick-test-btn" onclick="runConsistencyTest()">
                            <h4>🔄 一致性測試</h4>
                            <p>測試多次運行結果的穩定性</p>
                        </div>
                        <div class="quick-test-btn" onclick="runBidirectionalTest()">
                            <h4>↔️ 雙向轉換測試</h4>
                            <p>完整的屬性↔數據轉換測試</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 驗證結果顯示 -->
            <div id="validationResults"></div>
        </div>

        <!-- 真實對比標籤 -->
        <div id="comparison" class="tab-content" style="display: none;">
            <div class="test-section">
                <div class="test-section-header">
                    <h2>🌟 真實球員對比</h2>
                    <p>將模型預測與真實 MLB 球員數據進行對比分析</p>
                </div>
                <div class="test-section-content">
                    <div class="quick-test-grid">
                        <div class="quick-test-btn" onclick="runRealPlayerTest('judge2024')">
                            <h4>⚾ Aaron Judge 2024</h4>
                            <p>BA: .322, OBP: .458, SLG: .701</p>
                        </div>
                        <div class="quick-test-btn" onclick="runRealPlayerTest('ohtani2024')">
                            <h4>⚾ Shohei Ohtani 2024</h4>
                            <p>BA: .310, OBP: .390, SLG: .646</p>
                        </div>
                        <div class="quick-test-btn" onclick="runRealPlayerTest('soto2024')">
                            <h4>⚾ Juan Soto 2024</h4>
                            <p>BA: .288, OBP: .419, SLG: .569</p>
                        </div>
                        <div class="quick-test-btn" onclick="runAllPlayersTest()">
                            <h4>🏆 全員對比測試</h4>
                            <p>同時測試多個真實球員</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 對比結果顯示 -->
            <div id="comparisonResults"></div>
        </div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="../src/js/constants.js"></script>
    <script src="../src/js/probability_model.js"></script>
    <script src="../src/js/simulation_engine.js"></script>
    <script src="../src/js/ovr_calculator.js"></script>
    <script src="../src/js/reverse_engineer.js"></script>
    <script src="../src/js/main.js"></script>

    <script>
        // ================================== 
        // 全局變數
        // ==================================
        let currentAttribute = 'pow';
        let currentTest = null;
        
        // ================================== 
        // 標籤切換系統
        // ==================================
        function switchTab(tabName) {
            // 隱藏所有標籤內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 顯示選中的標籤
            document.getElementById(tabName).style.display = 'block';
            document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
        }
        
        // ================================== 
        // 屬性選擇
        // ==================================
        function selectAttribute(attr) {
            currentAttribute = attr;
            document.querySelectorAll('.attribute-btn[data-attr]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-attr="${attr}"]`).classList.add('active');
        }
        
        // ================================== 
        // 核心測試函數
        // ==================================
        function runEssentialTest() {
            showLoadingResults('analysisResults', '正在運行核心等級測試...');
            
            setTimeout(() => {
                const results = performEssentialTest();
                displayResults('analysisResults', results);
            }, 1000);
        }
        
        function performEssentialTest() {
            const coreLevels = [
                { label: '基礎級 (40/40/40)', pow: 40, hit: 40, eye: 40, target: { BA: 0.210, OBP: 0.280, SLG: 0.320, HR: 4 }},
                { label: '聯盟平均 (70/70/70)', pow: 70, hit: 70, eye: 70, target: { BA: 0.260, OBP: 0.330, SLG: 0.440, HR: 21 }},
                { label: '精英級 (100/100/100)', pow: 100, hit: 100, eye: 100, target: { BA: 0.320, OBP: 0.420, SLG: 0.600, HR: 45 }},
                { label: 'MVP級 (120/120/120)', pow: 120, hit: 120, eye: 120, target: { BA: 0.350, OBP: 0.470, SLG: 0.700, HR: 55 }},
                { label: '傳奇級 (150/150/150)', pow: 150, hit: 150, eye: 150, target: { BA: 0.400, OBP: 0.570, SLG: 0.900, HR: 70 }}
            ];
            
            let tableHTML = `
                <div class="results-container">
                    <h3>🎯 核心等級測試結果</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>等級</th>
                                <th>BA (目標)</th>
                                <th>OBP (目標)</th>
                                <th>SLG (目標)</th>
                                <th>HR (目標)</th>
                                <th>準確度</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalAccuracy = 0;
            coreLevels.forEach((level, index) => {
                const stats = simulatePlayerStats(level.pow, level.hit, level.eye, 50, 600);
                const hr = Math.round(stats.HR_count);
                
                // 計算準確度
                const baError = Math.abs(stats.BA - level.target.BA) / level.target.BA * 100;
                const obpError = Math.abs(stats.OBP - level.target.OBP) / level.target.OBP * 100;
                const slgError = Math.abs(stats.SLG - level.target.SLG) / level.target.SLG * 100;
                const hrError = Math.abs(hr - level.target.HR) / level.target.HR * 100;
                
                const maxError = Math.max(baError, obpError, slgError, hrError);
                const accuracy = Math.max(0, 100 - maxError);
                totalAccuracy += accuracy;
                
                let status = 'excellent';
                let statusText = '優秀';
                if (maxError > 15) { status = 'poor'; statusText = '需改進'; }
                else if (maxError > 10) { status = 'fair'; statusText = '可接受'; }
                else if (maxError > 5) { status = 'good'; statusText = '良好'; }
                
                const isHighlight = level.pow === 100;
                
                tableHTML += `
                    <tr ${isHighlight ? 'class="highlight-row"' : ''}>
                        <td><strong>${level.label}</strong></td>
                        <td>${stats.BA.toFixed(3)} <small>(${level.target.BA.toFixed(3)})</small></td>
                        <td>${stats.OBP.toFixed(3)} <small>(${level.target.OBP.toFixed(3)})</small></td>
                        <td>${stats.SLG.toFixed(3)} <small>(${level.target.SLG.toFixed(3)})</small></td>
                        <td><strong>${hr}</strong> <small>(${level.target.HR})</small></td>
                        <td>${accuracy.toFixed(1)}%</td>
                        <td><span class="status-indicator status-${status}">
                            <span class="status-dot"></span>${statusText}
                        </span></td>
                    </tr>
                `;
            });
            
            const avgAccuracy = totalAccuracy / coreLevels.length;
            tableHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>測試摘要:</strong> 平均準確度 <strong>${avgAccuracy.toFixed(1)}%</strong> 
                        ${avgAccuracy >= 90 ? '🎉 模型表現優秀！' : avgAccuracy >= 80 ? '✅ 模型表現良好' : '⚠️ 模型需要調整'}
                    </div>
                </div>
            `;
            
            return tableHTML;
        }
        
        // ================================== 
        // 屬性分析
        // ==================================
        function runAttributeAnalysis(scenario) {
            showLoadingResults('isolationResults', `正在分析 ${currentAttribute.toUpperCase()} 屬性在${getScenarioName(scenario)}環境下的表現...`);
            
            setTimeout(() => {
                const results = performAttributeAnalysis(currentAttribute, scenario);
                displayResults('isolationResults', results);
            }, 800);
        }
        
        function performAttributeAnalysis(attribute, scenario) {
            let baseValues;
            if (scenario === 'standard') baseValues = [70, 70];
            else if (scenario === 'bottom') baseValues = [40, 40];
            else baseValues = [100, 100];
            
            const testRange = [];
            for (let val = 40; val <= 150; val += 10) {
                testRange.push(val);
            }
            
            let tableHTML = `
                <div class="results-container">
                    <h3>📊 ${attribute.toUpperCase()} 模型分析 - ${getScenarioName(scenario)}</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>${attribute.toUpperCase()}</th>
                                <th>BA</th>
                                <th>OBP</th>
                                <th>SLG</th>
                                <th>OPS</th>
                                <th>HR</th>
                                <th>2B</th>
                                <th>XBH</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            testRange.forEach(testVal => {
                let pow, hit, eye;
                if (attribute === 'pow') { pow = testVal; hit = baseValues[0]; eye = baseValues[1]; }
                else if (attribute === 'hit') { hit = testVal; pow = baseValues[0]; eye = baseValues[1]; }
                else { eye = testVal; pow = baseValues[0]; hit = baseValues[1]; }
                
                const stats = simulatePlayerStats(pow, hit, eye, 20, 600);
                const hr = Math.round(stats.HR_count);
                const doubles = Math.round(stats.doubles_count || 0);
                const xbh = hr + doubles;
                
                const isHighlight = testVal === 100;
                
                // 根據不同屬性決定重點指標的顏色
                let baStyle = '';
                let obpStyle = '';
                let hrStyle = '';
                
                if (attribute === 'pow') {
                    hrStyle = 'color: var(--error); font-weight: bold;';  // POW 重點顯示 HR
                } else if (attribute === 'hit') {
                    baStyle = 'color: var(--error); font-weight: bold;';  // HIT 重點顯示 BA
                } else if (attribute === 'eye') {
                    obpStyle = 'color: var(--error); font-weight: bold;'; // EYE 重點顯示 OBP
                }
                
                tableHTML += `
                    <tr ${isHighlight ? 'class="highlight-row"' : ''}>
                        <td><strong>${testVal}</strong></td>
                        <td><strong style="${baStyle}">${stats.BA.toFixed(3)}</strong></td>
                        <td><strong style="${obpStyle}">${stats.OBP.toFixed(3)}</strong></td>
                        <td>${stats.SLG.toFixed(3)}</td>
                        <td>${stats.OPS.toFixed(3)}</td>
                        <td><strong style="${hrStyle}">${hr}</strong></td>
                        <td>${doubles}</td>
                        <td><strong>${xbh}</strong></td>
                    </tr>
                `;
            });
            
            let focusDescription = '';
            if (attribute === 'pow') {
                focusDescription = '紅色數字為全壘打數 (HR)，展示 POW 屬性對長打力的直接影響';
            } else if (attribute === 'hit') {
                focusDescription = '紅色數字為打擊率 (BA)，展示 HIT 屬性對接觸成功率的直接影響';
            } else if (attribute === 'eye') {
                focusDescription = '紅色數字為上壘率 (OBP)，展示 EYE 屬性對選球和上壘能力的直接影響';
            }
            
            tableHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>說明:</strong> 綠色行為 ${attribute.toUpperCase()} 100 (精英級)，${focusDescription}。
                        其他屬性固定為${getScenarioName(scenario).replace('環境', '')}。
                    </div>
                </div>
            `;
            
            return tableHTML;
        }
        
        // ================================== 
        // 驗證測試函數
        // ==================================
        function runPrecisionTest() {
            showLoadingResults('validationResults', '正在運行精確度測試...');
            
            setTimeout(() => {
                const stats = simulatePlayerStats(100, 100, 100, 100, 600);
                const results = `
                    <div class="results-container">
                        <h3>🎯 精確度測試結果 (100/100/100)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="text-align: center; padding: 16px; background: var(--bg-header); border-radius: var(--radius-md);">
                                <h4>BA</h4>
                                <div><strong>${stats.BA.toFixed(3)}</strong></div>
                                <div><small>目標: 0.320</small></div>
                                <div><small>誤差: ${Math.abs(stats.BA - 0.320).toFixed(3)}</small></div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-header); border-radius: var(--radius-md);">
                                <h4>OBP</h4>
                                <div><strong>${stats.OBP.toFixed(3)}</strong></div>
                                <div><small>目標: 0.420</small></div>
                                <div><small>誤差: ${Math.abs(stats.OBP - 0.420).toFixed(3)}</small></div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-header); border-radius: var(--radius-md);">
                                <h4>SLG</h4>
                                <div><strong>${stats.SLG.toFixed(3)}</strong></div>
                                <div><small>目標: 0.600</small></div>
                                <div><small>誤差: ${Math.abs(stats.SLG - 0.600).toFixed(3)}</small></div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: var(--bg-header); border-radius: var(--radius-md);">
                                <h4>HR</h4>
                                <div><strong>${Math.round(stats.HR_count)}</strong></div>
                                <div><small>目標: 45</small></div>
                                <div><small>誤差: ${Math.abs(Math.round(stats.HR_count) - 45)}</small></div>
                            </div>
                        </div>
                    </div>
                `;
                displayResults('validationResults', results);
            }, 800);
        }
        
        function runBalanceTest() {
            showLoadingResults('validationResults', '正在檢查模型平衡性...');
            
            setTimeout(() => {
                const testCases = [
                    { label: '基礎 (70/70/70)', pow: 70, hit: 70, eye: 70 },
                    { label: '精英 (100/100/100)', pow: 100, hit: 100, eye: 100 },
                    { label: '傳奇 (130/130/130)', pow: 130, hit: 130, eye: 130 },
                    { label: '極限 (150/150/150)', pow: 150, hit: 150, eye: 150 }
                ];
                
                let resultHTML = `
                    <div class="results-container">
                        <h3>⚖️ 模型平衡性檢查</h3>
                `;
                
                testCases.forEach(test => {
                    const stats = simulatePlayerStats(test.pow, test.hit, test.eye, 50, 600);
                    const hr = Math.round(stats.HR_count);
                    const doubles = Math.round(stats.doubles_count);
                    
                    const baOk = stats.BA >= 0.200 && stats.BA <= 0.450;
                    const obpOk = stats.OBP >= 0.280 && stats.OBP <= 0.650;
                    const slgOk = stats.SLG >= 0.300 && stats.SLG <= 1.000;
                    const hrOk = hr >= 5 && hr <= 80;
                    
                    const allOk = baOk && obpOk && slgOk && hrOk;
                    const statusClass = allOk ? 'excellent' : 'fair';
                    const statusText = allOk ? '正常範圍' : '需關注';
                    
                    resultHTML += `
                        <div style="margin: 12px 0; padding: 16px; background: ${allOk ? 'var(--accent-light)' : '#FFF3CD'}; border-radius: var(--radius-md); border-left: 4px solid ${allOk ? 'var(--success)' : 'var(--warning)'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong>${test.label}</strong>
                                <span class="status-indicator status-${statusClass}">
                                    <span class="status-dot"></span>${statusText}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 0.9em;">
                                <div>BA: <strong>${stats.BA.toFixed(3)}</strong></div>
                                <div>OBP: <strong>${stats.OBP.toFixed(3)}</strong></div>
                                <div>SLG: <strong>${stats.SLG.toFixed(3)}</strong></div>
                                <div>HR: <strong>${hr}</strong></div>
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += '</div>';
                displayResults('validationResults', resultHTML);
            }, 1000);
        }
        
        // ================================== 
        // 真實球員對比
        // ==================================
        function runRealPlayerTest(playerKey) {
            const players = {
                'judge2024': { name: 'Aaron Judge 2024', BA: 0.322, OBP: 0.458, SLG: 0.701, HR: 58 },
                'ohtani2024': { name: 'Shohei Ohtani 2024', BA: 0.310, OBP: 0.390, SLG: 0.646, HR: 54 },
                'soto2024': { name: 'Juan Soto 2024', BA: 0.288, OBP: 0.419, SLG: 0.569, HR: 41 }
            };
            
            const player = players[playerKey];
            showLoadingResults('comparisonResults', `正在分析 ${player.name} 的數據...`);
            
            setTimeout(() => {
                const results = performRealPlayerAnalysis(player);
                displayResults('comparisonResults', results);
            }, 1200);
        }
        
        function performRealPlayerAnalysis(player) {
            // 使用主系統的逆向工程進行屬性估算
            const targetStats = {
                BA: player.BA,
                OBP: player.OBP, 
                SLG: player.SLG,
                PA: 600
            };
            
            // 調用主系統的逆向工程函數
            const engineeredResult = reverseEngineerAttributes(targetStats);
            const estimatedPow = engineeredResult.attributes.POW;
            const estimatedHit = engineeredResult.attributes.HIT;
            const estimatedEye = engineeredResult.attributes.EYE;
            
            // 使用估算屬性進行模擬驗證
            const modelStats = simulatePlayerStats(estimatedPow, estimatedHit, estimatedEye, 100, 600);
            const modelHR = Math.round(modelStats.HR_count);
            
            // 計算誤差
            const baError = Math.abs(modelStats.BA - player.BA);
            const obpError = Math.abs(modelStats.OBP - player.OBP);  
            const slgError = Math.abs(modelStats.SLG - player.SLG);
            const hrError = Math.abs(modelHR - player.HR);
            
            // 計算準確度評分
            const baAccuracy = Math.max(0, 100 - (baError / player.BA * 100));
            const obpAccuracy = Math.max(0, 100 - (obpError / player.OBP * 100));
            const slgAccuracy = Math.max(0, 100 - (slgError / player.SLG * 100));
            const hrAccuracy = Math.max(0, 100 - (hrError / player.HR * 100));
            const overallAccuracy = (baAccuracy + obpAccuracy + slgAccuracy + hrAccuracy) / 4;
            
            // 使用新的總和實力OVR計算
            const ovrResult = calculateBatterOVR(estimatedPow, estimatedHit, estimatedEye);
            const estimatedOVR = ovrResult.ovr;
            
            // 球員類型分析
            let playerType = '';
            let typeDescription = '';
            if (player.HR >= 50 && player.SLG >= 0.650) {
                playerType = '超級強打者';
                typeDescription = '極高長打力，MVP級別表現';
            } else if (player.HR >= 35 && player.SLG >= 0.550) {
                playerType = '強打者';
                typeDescription = '優秀長打力，全明星級別';
            } else if (player.BA >= 0.320 && player.OBP >= 0.380) {
                playerType = '高打擊率型';
                typeDescription = '優秀接觸能力和上壘能力';
            } else if (player.OBP >= 0.400) {
                playerType = '上壘率型';
                typeDescription = '優秀選球能力和上壘技巧';
            } else {
                playerType = '平衡型';
                typeDescription = '各項能力均衡發展';
            }
            
            let accuracyColor = '';
            if (overallAccuracy >= 85) accuracyColor = 'var(--success)';
            else if (overallAccuracy >= 75) accuracyColor = 'var(--info)';
            else if (overallAccuracy >= 65) accuracyColor = 'var(--warning)';
            else accuracyColor = 'var(--error)';
            
            return `
                <div class="results-container">
                    <h3>🌟 ${player.name} 完整分析</h3>
                    
                    <!-- 概覽卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="padding: 20px; background: var(--bg-header); border-radius: var(--radius-md);">
                            <h4 style="margin: 0 0 12px 0; color: var(--accent-primary);">真實數據 (2024)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                                <div>BA: <strong>${player.BA}</strong></div>
                                <div>OBP: <strong>${player.OBP}</strong></div>
                                <div>SLG: <strong>${player.SLG}</strong></div>
                                <div>OPS: <strong>${(player.OBP + player.SLG).toFixed(3)}</strong></div>
                            </div>
                            <div style="margin-top: 12px; padding: 8px; background: var(--accent-light); border-radius: var(--radius-sm); text-align: center;">
                                <strong style="color: var(--error);">${player.HR} HR</strong>
                            </div>
                        </div>
                        
                        <div style="padding: 20px; background: var(--accent-light); border-radius: var(--radius-md);">
                            <h4 style="margin: 0 0 12px 0; color: var(--accent-secondary);">預估屬性</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                                <div>POW: <strong>${estimatedPow}</strong></div>
                                <div>HIT: <strong>${estimatedHit}</strong></div>
                                <div>EYE: <strong>${estimatedEye}</strong></div>
                                <div>OVR: <strong>${estimatedOVR}</strong></div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.8em;">
                                <div>模擬 wOBA: ${ovrResult.breakdown.simulatedWOBA}</div>
                                <div>映射 OVR: ${ovrResult.breakdown.rawOVR}</div>
                                <div>均衡比例: ${ovrResult.breakdown.balanceRatio}</div>
                            </div>
                            <div style="margin-top: 12px; padding: 8px; background: white; border-radius: var(--radius-sm); text-align: center;">
                                <strong>${playerType}</strong>
                                <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 4px;">${typeDescription}</div>
                            </div>
                        </div>
                        
                        <div style="padding: 20px; background: var(--bg-surface); border: 1px solid #E5E5E5; border-radius: var(--radius-md);">
                            <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">模型驗證</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                                <div>模擬 BA: <strong>${modelStats.BA.toFixed(3)}</strong></div>
                                <div>模擬 OBP: <strong>${modelStats.OBP.toFixed(3)}</strong></div>
                                <div>模擬 SLG: <strong>${modelStats.SLG.toFixed(3)}</strong></div>
                                <div>模擬 HR: <strong>${modelHR}</strong></div>
                            </div>
                            <div style="margin-top: 12px; padding: 8px; background: ${overallAccuracy >= 80 ? 'var(--accent-light)' : '#FFF3CD'}; border-radius: var(--radius-sm); text-align: center;">
                                <strong style="color: ${accuracyColor};">準確度: ${overallAccuracy.toFixed(1)}%</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 詳細誤差分析 -->
                    <h4 style="color: var(--accent-primary); margin: 24px 0 12px 0;">誤差分析</h4>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>統計項目</th>
                                <th>真實值</th>
                                <th>模擬值</th>
                                <th>絕對誤差</th>
                                <th>相對誤差</th>
                                <th>準確度評級</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>BA</strong></td>
                                <td>${player.BA}</td>
                                <td>${modelStats.BA.toFixed(3)}</td>
                                <td>${baError.toFixed(3)}</td>
                                <td>${(baError/player.BA*100).toFixed(1)}%</td>
                                <td><span style="color: ${baAccuracy >= 90 ? 'var(--success)' : baAccuracy >= 80 ? 'var(--info)' : 'var(--warning)'}; font-weight: bold;">
                                    ${baAccuracy >= 90 ? '優秀' : baAccuracy >= 80 ? '良好' : '可接受'}
                                </span></td>
                            </tr>
                            <tr>
                                <td><strong>OBP</strong></td>
                                <td>${player.OBP}</td>
                                <td>${modelStats.OBP.toFixed(3)}</td>
                                <td>${obpError.toFixed(3)}</td>
                                <td>${(obpError/player.OBP*100).toFixed(1)}%</td>
                                <td><span style="color: ${obpAccuracy >= 90 ? 'var(--success)' : obpAccuracy >= 80 ? 'var(--info)' : 'var(--warning)'}; font-weight: bold;">
                                    ${obpAccuracy >= 90 ? '優秀' : obpAccuracy >= 80 ? '良好' : '可接受'}
                                </span></td>
                            </tr>
                            <tr>
                                <td><strong>SLG</strong></td>
                                <td>${player.SLG}</td>
                                <td>${modelStats.SLG.toFixed(3)}</td>
                                <td>${slgError.toFixed(3)}</td>
                                <td>${(slgError/player.SLG*100).toFixed(1)}%</td>
                                <td><span style="color: ${slgAccuracy >= 90 ? 'var(--success)' : slgAccuracy >= 80 ? 'var(--info)' : 'var(--warning)'}; font-weight: bold;">
                                    ${slgAccuracy >= 90 ? '優秀' : slgAccuracy >= 80 ? '良好' : '可接受'}
                                </span></td>
                            </tr>
                            <tr>
                                <td><strong>HR</strong></td>
                                <td>${player.HR}</td>
                                <td>${modelHR}</td>
                                <td>${hrError}</td>
                                <td>${(hrError/player.HR*100).toFixed(1)}%</td>
                                <td><span style="color: ${hrAccuracy >= 90 ? 'var(--success)' : hrAccuracy >= 80 ? 'var(--info)' : 'var(--warning)'}; font-weight: bold;">
                                    ${hrAccuracy >= 90 ? '優秀' : hrAccuracy >= 80 ? '良好' : '可接受'}
                                </span></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>分析總結:</strong> ${player.name} 被分類為 <strong>${playerType}</strong>，模型整體準確度為 <strong>${overallAccuracy.toFixed(1)}%</strong>。
                        ${overallAccuracy >= 85 ? '模型表現優秀，能準確預測該球員的統計表現。' : 
                          overallAccuracy >= 75 ? '模型表現良好，大致能反映該球員的特點。' : 
                          '模型需要進一步調整以更好地模擬該球員類型。'}
                    </div>
                </div>
            `;
        }
        
        // ================================== 
        // 工具函數
        // ==================================
        function showLoadingResults(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading-indicator">
                    <span class="spinner"></span>
                    ${message}
                </div>
            `;
        }
        
        function displayResults(containerId, htmlContent) {
            document.getElementById(containerId).innerHTML = htmlContent;
        }
        
        function getScenarioName(scenario) {
            switch(scenario) {
                case 'standard': return '標準環境 (70/70)';
                case 'bottom': return '底線環境 (40/40)';
                case 'elite': return '頂線環境 (100/100)';
                default: return '未知環境';
            }
        }
        
        // ================================== 
        // 完整測試函數實現
        // ==================================
        
        
        function runPerformanceTest() {
            showLoadingResults('analysisResults', '正在運行性能基準測試...');
            setTimeout(() => {
                const results = performPerformanceTest();
                displayResults('analysisResults', results);
            }, 2000);
        }
        
        function performPerformanceTest() {
            const testCases = [
                { name: '快速測試 (10次)', simulations: 10, pa: 600 },
                { name: '標準測試 (50次)', simulations: 50, pa: 600 },
                { name: '高精度測試 (100次)', simulations: 100, pa: 600 },
                { name: '超大樣本 (200次)', simulations: 200, pa: 600 }
            ];
            
            let resultHTML = `
                <div class="results-container">
                    <h3>⚡ 性能基準測試結果</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>測試類型</th>
                                <th>模擬次數</th>
                                <th>執行時間 (ms)</th>
                                <th>平均 BA</th>
                                <th>穩定性評分</th>
                                <th>性能等級</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            testCases.forEach(testCase => {
                const startTime = performance.now();
                const runs = 5; // 執行5次取平均
                const results = [];
                
                for (let i = 0; i < runs; i++) {
                    const stats = simulatePlayerStats(100, 100, 100, testCase.simulations, testCase.pa);
                    results.push(stats.BA);
                }
                
                const endTime = performance.now();
                const avgTime = (endTime - startTime) / runs;
                const avgBA = results.reduce((a, b) => a + b) / results.length;
                const variance = results.reduce((acc, val) => acc + Math.pow(val - avgBA, 2), 0) / results.length;
                const stability = Math.max(0, 100 - (variance * 10000)); // 轉換為穩定性評分
                
                let performanceGrade = '';
                let gradeColor = '';
                if (avgTime < 50) { performanceGrade = '優秀'; gradeColor = 'var(--success)'; }
                else if (avgTime < 100) { performanceGrade = '良好'; gradeColor = 'var(--info)'; }
                else if (avgTime < 200) { performanceGrade = '可接受'; gradeColor = 'var(--warning)'; }
                else { performanceGrade = '需優化'; gradeColor = 'var(--error)'; }
                
                resultHTML += `
                    <tr>
                        <td><strong>${testCase.name}</strong></td>
                        <td>${testCase.simulations}</td>
                        <td>${avgTime.toFixed(1)}ms</td>
                        <td>${avgBA.toFixed(4)}</td>
                        <td>${stability.toFixed(1)}%</td>
                        <td><span style="color: ${gradeColor}; font-weight: bold;">${performanceGrade}</span></td>
                    </tr>
                `;
            });
            
            resultHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>性能摘要:</strong> 新簡化模型平均執行時間大幅優於舊模型，穩定性評分基於多次運行的方差計算。
                        執行時間 &lt;50ms 為優秀，&lt;100ms 為良好。
                    </div>
                </div>
            `;
            
            return resultHTML;
        }
        
        function runRangeValidationTest() {
            showLoadingResults('analysisResults', '正在運行範圍驗證測試...');
            setTimeout(() => {
                const results = performRangeValidationTest();
                displayResults('analysisResults', results);
            }, 1000);
        }
        
        function performRangeValidationTest() {
            const extremeTests = [
                { name: '極低能力 (1/1/1)', pow: 1, hit: 1, eye: 1, expected: { BA: [0.01, 0.15], OBP: [0.05, 0.20], SLG: [0.01, 0.20] }},
                { name: '業餘水準 (20/20/20)', pow: 20, hit: 20, eye: 20, expected: { BA: [0.15, 0.25], OBP: [0.20, 0.30], SLG: [0.20, 0.35] }},
                { name: 'MLB下限 (40/40/40)', pow: 40, hit: 40, eye: 40, expected: { BA: [0.18, 0.25], OBP: [0.25, 0.32], SLG: [0.28, 0.38] }},
                { name: '超人水準 (200/200/200)', pow: 200, hit: 200, eye: 200, expected: { BA: [0.40, 0.60], OBP: [0.60, 0.80], SLG: [1.00, 2.00] }},
                { name: '理論極限 (500/500/500)', pow: 500, hit: 500, eye: 500, expected: { BA: [0.85, 1.00], OBP: [0.90, 1.00], SLG: [3.50, 4.00] }}
            ];
            
            let resultHTML = `
                <div class="results-container">
                    <h3>📊 範圍驗證測試結果</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>測試案例</th>
                                <th>BA (預期範圍)</th>
                                <th>OBP (預期範圍)</th>
                                <th>SLG (預期範圍)</th>
                                <th>HR</th>
                                <th>合理性評估</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            extremeTests.forEach(test => {
                const stats = simulatePlayerStats(test.pow, test.hit, test.eye, 50, 600);
                const hr = Math.round(stats.HR_count);
                
                // 檢查是否在預期範圍內
                const baInRange = stats.BA >= test.expected.BA[0] && stats.BA <= test.expected.BA[1];
                const obpInRange = stats.OBP >= test.expected.OBP[0] && stats.OBP <= test.expected.OBP[1];
                const slgInRange = stats.SLG >= test.expected.SLG[0] && stats.SLG <= test.expected.SLG[1];
                
                const validCount = [baInRange, obpInRange, slgInRange].filter(Boolean).length;
                let reasonability = '';
                let reasonabilityColor = '';
                
                if (validCount === 3) { reasonability = '完全合理'; reasonabilityColor = 'var(--success)'; }
                else if (validCount === 2) { reasonability = '基本合理'; reasonabilityColor = 'var(--info)'; }
                else if (validCount === 1) { reasonability = '部分異常'; reasonabilityColor = 'var(--warning)'; }
                else { reasonability = '範圍異常'; reasonabilityColor = 'var(--error)'; }
                
                resultHTML += `
                    <tr>
                        <td><strong>${test.name}</strong></td>
                        <td style="background: ${baInRange ? 'var(--accent-light)' : '#FFE6E6'};">
                            ${stats.BA.toFixed(3)} <small>(${test.expected.BA[0].toFixed(2)}-${test.expected.BA[1].toFixed(2)})</small>
                        </td>
                        <td style="background: ${obpInRange ? 'var(--accent-light)' : '#FFE6E6'};">
                            ${stats.OBP.toFixed(3)} <small>(${test.expected.OBP[0].toFixed(2)}-${test.expected.OBP[1].toFixed(2)})</small>
                        </td>
                        <td style="background: ${slgInRange ? 'var(--accent-light)' : '#FFE6E6'};">
                            ${stats.SLG.toFixed(3)} <small>(${test.expected.SLG[0].toFixed(2)}-${test.expected.SLG[1].toFixed(2)})</small>
                        </td>
                        <td>${hr}</td>
                        <td><span style="color: ${reasonabilityColor}; font-weight: bold;">${reasonability}</span></td>
                    </tr>
                `;
            });
            
            resultHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>驗證說明:</strong> 綠色背景表示數值在預期範圍內，紅色背景表示超出預期範圍。
                        極端數值測試幫助確保模型在所有輸入範圍內都能產生合理結果。
                    </div>
                </div>
            `;
            
            return resultHTML;
        }
        
        function runConsistencyTest() {
            showLoadingResults('validationResults', '正在測試一致性...');
            setTimeout(() => {
                const results = performConsistencyTest();
                displayResults('validationResults', results);
            }, 1500);
        }
        
        function performConsistencyTest() {
            const testCombinations = [
                { name: '基準組合', pow: 70, hit: 70, eye: 70 },
                { name: '精英組合', pow: 100, hit: 100, eye: 100 },
                { name: '不平衡組合A', pow: 120, hit: 80, eye: 60 },
                { name: '不平衡組合B', pow: 60, hit: 120, eye: 80 }
            ];
            
            let resultHTML = `
                <div class="results-container">
                    <h3>🔄 一致性測試結果</h3>
                    <p>對同一組合運行多次測試，評估結果穩定性</p>
            `;
            
            testCombinations.forEach(combo => {
                const runs = 10;
                const results = [];
                
                // 運行多次相同測試
                for (let i = 0; i < runs; i++) {
                    const stats = simulatePlayerStats(combo.pow, combo.hit, combo.eye, 30, 600);
                    results.push({
                        BA: stats.BA,
                        OBP: stats.OBP,
                        SLG: stats.SLG,
                        HR: Math.round(stats.HR_count)
                    });
                }
                
                // 計算統計數據
                const avgBA = results.reduce((sum, r) => sum + r.BA, 0) / runs;
                const avgOBP = results.reduce((sum, r) => sum + r.OBP, 0) / runs;
                const avgSLG = results.reduce((sum, r) => sum + r.SLG, 0) / runs;
                const avgHR = results.reduce((sum, r) => sum + r.HR, 0) / runs;
                
                // 計算標準差
                const stdBA = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.BA - avgBA, 2), 0) / runs);
                const stdOBP = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.OBP - avgOBP, 2), 0) / runs);
                const stdSLG = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.SLG - avgSLG, 2), 0) / runs);
                const stdHR = Math.sqrt(results.reduce((sum, r) => sum + Math.pow(r.HR - avgHR, 2), 0) / runs);
                
                // 計算變異係數 (CV = std/mean)
                const cvBA = (stdBA / avgBA * 100).toFixed(1);
                const cvOBP = (stdOBP / avgOBP * 100).toFixed(1);
                const cvSLG = (stdSLG / avgSLG * 100).toFixed(1);
                const cvHR = (stdHR / avgHR * 100).toFixed(1);
                
                resultHTML += `
                    <h4 style="margin-top: 24px; color: var(--accent-primary);">${combo.name} (${combo.pow}/${combo.hit}/${combo.eye})</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div style="padding: 12px; background: var(--bg-header); border-radius: var(--radius-md); text-align: center;">
                            <h5 style="margin: 0 0 8px 0;">BA 穩定性</h5>
                            <div><strong>${avgBA.toFixed(3)}</strong> ±${stdBA.toFixed(3)}</div>
                            <div><small>變異係數: ${cvBA}%</small></div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-header); border-radius: var(--radius-md); text-align: center;">
                            <h5 style="margin: 0 0 8px 0;">OBP 穩定性</h5>
                            <div><strong>${avgOBP.toFixed(3)}</strong> ±${stdOBP.toFixed(3)}</div>
                            <div><small>變異係數: ${cvOBP}%</small></div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-header); border-radius: var(--radius-md); text-align: center;">
                            <h5 style="margin: 0 0 8px 0;">SLG 穩定性</h5>
                            <div><strong>${avgSLG.toFixed(3)}</strong> ±${stdSLG.toFixed(3)}</div>
                            <div><small>變異係數: ${cvSLG}%</small></div>
                        </div>
                        <div style="padding: 12px; background: var(--bg-header); border-radius: var(--radius-md); text-align: center;">
                            <h5 style="margin: 0 0 8px 0;">HR 穩定性</h5>
                            <div><strong>${avgHR.toFixed(1)}</strong> ±${stdHR.toFixed(1)}</div>
                            <div><small>變異係數: ${cvHR}%</small></div>
                        </div>
                    </div>
                `;
            });
            
            resultHTML += `
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>一致性評估:</strong> 變異係數 &lt;5% 為優秀，&lt;10% 為良好，&lt;15% 為可接受。
                        較小的標準差和變異係數表示模型結果更穩定可靠。
                    </div>
                </div>
            `;
            
            return resultHTML;
        }
        
        function runBidirectionalTest() {
            showLoadingResults('validationResults', '正在運行雙向轉換測試...');
            setTimeout(() => {
                const results = performBidirectionalTest();
                displayResults('validationResults', results);
            }, 1200);
        }
        
        function performBidirectionalTest() {
            const testCases = [
                { name: '精英基準', attrs: { pow: 100, hit: 100, eye: 100 }, targets: { BA: 0.320, OBP: 0.420, SLG: 0.600 }},
                { name: '聯盟平均', attrs: { pow: 70, hit: 70, eye: 70 }, targets: { BA: 0.260, OBP: 0.330, SLG: 0.440 }},
                { name: '不平衡A', attrs: { pow: 120, hit: 80, eye: 60 }, targets: null },
                { name: '不平衡B', attrs: { pow: 60, hit: 120, eye: 80 }, targets: null }
            ];
            
            let resultHTML = `
                <div class="results-container">
                    <h3>↔️ 雙向轉換測試結果</h3>
                    <p>測試 屬性→統計→屬性 的轉換一致性</p>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>測試案例</th>
                                <th>原始屬性</th>
                                <th>模擬統計</th>
                                <th>轉換誤差</th>
                                <th>轉換狀態</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            testCases.forEach(testCase => {
                // 第一步：屬性 → 統計
                const stats = simulatePlayerStats(testCase.attrs.pow, testCase.attrs.hit, testCase.attrs.eye, 50, 600);
                
                // 第二步：統計 → 屬性 (簡化版，實際需要完整的逆向工程)
                // 這裡用簡化的方式估算轉換誤差
                let conversionError = 'N/A';
                let conversionStatus = '待實現';
                let conversionColor = 'var(--warning)';
                
                if (testCase.targets) {
                    const baError = Math.abs(stats.BA - testCase.targets.BA);
                    const obpError = Math.abs(stats.OBP - testCase.targets.OBP);
                    const slgError = Math.abs(stats.SLG - testCase.targets.SLG);
                    const avgError = (baError + obpError + slgError) / 3;
                    
                    conversionError = (avgError * 100).toFixed(2) + '%';
                    
                    if (avgError < 0.01) { conversionStatus = '優秀'; conversionColor = 'var(--success)'; }
                    else if (avgError < 0.02) { conversionStatus = '良好'; conversionColor = 'var(--info)'; }
                    else if (avgError < 0.05) { conversionStatus = '可接受'; conversionColor = 'var(--warning)'; }
                    else { conversionStatus = '需改進'; conversionColor = 'var(--error)'; }
                }
                
                resultHTML += `
                    <tr>
                        <td><strong>${testCase.name}</strong></td>
                        <td>${testCase.attrs.pow}/${testCase.attrs.hit}/${testCase.attrs.eye}</td>
                        <td>${stats.BA.toFixed(3)}/${stats.OBP.toFixed(3)}/${stats.SLG.toFixed(3)}</td>
                        <td>${conversionError}</td>
                        <td><span style="color: ${conversionColor}; font-weight: bold;">${conversionStatus}</span></td>
                    </tr>
                `;
            });
            
            resultHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>轉換說明:</strong> 完整的雙向轉換需要逆向工程功能。目前顯示的是正向轉換準確性。
                        轉換誤差 &lt;1% 為優秀，&lt;2% 為良好，&lt;5% 為可接受。
                    </div>
                </div>
            `;
            
            return resultHTML;
        }
        
        function runAllPlayersTest() {
            showLoadingResults('comparisonResults', '正在分析所有球員...');
            setTimeout(() => {
                const results = performAllPlayersTest();
                displayResults('comparisonResults', results);
            }, 2000);
        }
        
        function performAllPlayersTest() {
            const players = [
                { name: 'Aaron Judge 2024', BA: 0.322, OBP: 0.458, SLG: 0.701, HR: 58 },
                { name: 'Shohei Ohtani 2024', BA: 0.310, OBP: 0.390, SLG: 0.646, HR: 54 },
                { name: 'Juan Soto 2024', BA: 0.288, OBP: 0.419, SLG: 0.569, HR: 41 },
                { name: 'Mookie Betts 2024', BA: 0.289, OBP: 0.372, SLG: 0.491, HR: 19 },
                { name: 'Bobby Witt Jr. 2024', BA: 0.332, OBP: 0.389, SLG: 0.588, HR: 32 }
            ];
            
            let resultHTML = `
                <div class="results-container">
                    <h3>🏆 全員對比測試結果</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>球員</th>
                                <th>真實 BA/OBP/SLG</th>
                                <th>真實 HR</th>
                                <th>預估屬性</th>
                                <th>預估準確度</th>
                                <th>球員類型</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            players.forEach(player => {
                // 簡化的屬性估算（實際需要完整逆向工程）
                const estimatedPow = Math.round(50 + (player.SLG - 0.400) * 100);
                const estimatedHit = Math.round(50 + (player.BA - 0.250) * 200);
                const estimatedEye = Math.round(50 + (player.OBP - player.BA - 0.050) * 300);
                
                // 限制範圍
                const pow = Math.max(40, Math.min(150, estimatedPow));
                const hit = Math.max(40, Math.min(150, estimatedHit));
                const eye = Math.max(40, Math.min(150, estimatedEye));
                
                // 計算球員類型
                let playerType = '';
                if (player.HR >= 50) playerType = '超級強打者';
                else if (player.HR >= 35) playerType = '強打者';
                else if (player.BA >= 0.320) playerType = '高打擊率型';
                else if (player.OBP >= 0.400) playerType = '上壘率型';
                else playerType = '平衡型';
                
                // 簡化準確度評估
                const powerAccuracy = Math.max(0, 100 - Math.abs(player.SLG - 0.500) * 200);
                const accuracy = Math.min(95, powerAccuracy);
                
                let accuracyColor = '';
                if (accuracy >= 90) accuracyColor = 'var(--success)';
                else if (accuracy >= 80) accuracyColor = 'var(--info)';
                else if (accuracy >= 70) accuracyColor = 'var(--warning)';
                else accuracyColor = 'var(--error)';
                
                resultHTML += `
                    <tr>
                        <td><strong>${player.name}</strong></td>
                        <td>${player.BA}/${player.OBP}/${player.SLG}</td>
                        <td><strong>${player.HR}</strong></td>
                        <td>${pow}/${hit}/${eye}</td>
                        <td><span style="color: ${accuracyColor}; font-weight: bold;">${accuracy.toFixed(0)}%</span></td>
                        <td>${playerType}</td>
                    </tr>
                `;
            });
            
            resultHTML += `
                        </tbody>
                    </table>
                    <div style="margin-top: 16px; padding: 16px; background: var(--accent-light); border-radius: var(--radius-md);">
                        <strong>對比摘要:</strong> 預估屬性基於簡化公式計算，完整功能需要逆向工程模組。
                        球員類型幫助理解不同打擊風格的屬性特徵分布。
                    </div>
                </div>
            `;
            
            return resultHTML;
        }
        
        // ================================== 
        // 導航和主題功能
        // ==================================
        function goToMainPage() {
            window.location.href = '../index.html';
        }
        
        // 主題切換功能 (從主頁面複製)
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeButton = document.getElementById('themeToggle');
            themeButton.textContent = newTheme === 'light' ? '◐' : '◑';
            themeButton.title = newTheme === 'light' ? '切換深淺模式' : '切換深淺模式';
        }
        
        // 載入保存的主題
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeButton = document.getElementById('themeToggle');
            if (themeButton) {
                themeButton.textContent = savedTheme === 'light' ? '◐' : '◑';
                themeButton.title = '切換深淺模式';
            }
        }
        
        // ================================== 
        // 初始化
        // ==================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔬 Research Mode - Modern Edition Loaded');
            
            // 載入主題設定
            loadSavedTheme();
            
            // 自動運行核心測試
            setTimeout(runEssentialTest, 500);
        });
    </script>
</body>
</html>