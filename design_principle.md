# 專案設計原則（Design Principles）

本文件為本專案之設計與實作準則。內容涵蓋演算法校準原則、參數調整流程、測試標準、介面設計風格與文件維運規範。所有改動應先對照本文件，再進行提交。


## 一、棒球演算法設計準則（Baseball Algorithm Design Principles）

- 核心理念：保持雙向轉換（屬性 ↔ 統計）的一致性與準確性，同時尊重 MLB 統計分佈與屬性交互影響。

### 1. 基準穩定原則（Benchmark Stability Principle）
- 不得任意變更聯盟基準（LEAGUE_BENCHMARKS）。
- 基準來源固定，模型失配時，應調整「錨點／參數」，而非調整基準。
- 目前基準（示例）
  - xBA: pr1=0.210, pr50=0.250, pr99=0.320
  - xSLG: pr1=0.320, pr50=0.420, pr99=0.570
  - xwOBA: pr1=0.280, pr50=0.320, pr99=0.420

### 2. 分層測試流程（Hierarchical Testing Approach）
- 依序執行，前一層未穩定，不進下一層。
- 基礎驗證：
  - 單一屬性測試（70/100/70、100/70/70、70/70/100），每一項需達成相對應基準。
  - 聯盟平均（70/70/70）→ 雙向總誤差 < 10（必須通過）。
- 同級組合：
  - 40/40/40、100/100/100 → 可接受誤差 < 10（總和）。
- 混合組合：
  - 例如 40/70/100 → 誤差容忍較高，必要時使用迭代優化。

### 3. 屬性交互承認（Attribute Interaction Acknowledgment）
- 混合屬性本質較難，勿為此過度犧牲基礎準確度。
- 效果傾向「乘法型」，而非簡單相加。
- 例：HIT 100 與 EYE 40/100 的實際表現不同。

### 4. 參數調整層級（Model Parameter Hierarchy）
- 優先等級（高 → 低）：
  1) 錨點（S-Curve 斷點）
     - 例：HR_S_CURVE_POW_ANCHORS、BABIP_S_CURVE_HIT_ANCHORS、BB_S_CURVE_EYE_ANCHORS
  2) 交互效應（Interaction Effects）
     - 例：HIT/EYE 對 HR 的修正係數
  3) 上下限與封頂（Caps & Limits）
     - 僅作為最後手段；需詳寫理由。

### 5. 變更紀錄原則（Change Documentation Principle）
- 每次調整必須寫明：
  - 為何（對應哪個測試失敗）
  - 修改了什麼（參數/錨點與值）
  - 期望影響（量化改善目標）
  - 驗證結果（通過哪些測試、數值）

### 6. 測試標準（Testing Standards）
- 雙向準確目標（每屬性總誤差）
  - 優：< 3
  - 良：< 6
  - 可：< 15
  - 不可接受：> 15
- 核心測試（必須通過）
  - 70/70/70：總誤差 < 10
  - 40/40/40：總誤差 < 15
  - 100/100/100：總誤差 < 20
- 基準驗證
  - POW 100（HIT=70,EYE=70）→ SLG ≈ 0.570 ± 0.030
  - HIT 100（POW=70,EYE=70）→ BA ≈ 0.320 ± 0.020
  - EYE 100（POW=70,HIT=70）→ OBP ≈ 0.420 ± 0.025

### 7. 反模式（Anti-Patterns）
- 調整基準以迎合現輸出（禁止）。
- 過度優化混合組合，忽略基礎準確（禁止）。
- 同時調整多項參數而無對照（禁止）。
- 只針對極端組合（100/100/100）做優化（避免）。

### 8. 實作指引（Implementation Guidelines）
- 使用數學優化，不依賴拍腦公式。
- 兩階段搜尋：廣泛隨機搜尋 → 近域精調。
- 以多組組合的「總誤差」作為損失函數。
- 參考 `old_python_calculate_models/optimization_utils.py`。
- 拆分關注點：錨點、基準、交互效應分離管理；常數命名清晰可查；支持 A/B 參數組切換；固定隨機種子確保可重現。

### 9. 成功指標（Success Metrics）
- 基礎穩定：70/70/70 長期 < 10。
- 範圍覆蓋：40–100 組合維持合理誤差。
- MLB 相符：單一屬性能擊中基準。
- 雙向一致：往返轉換漂移 < 15%。
- 效能：單次轉換 < 1 秒；80% 測試案例達「良」以上。

### 10. 決策流程（Decision Framework）
```
1) 70/70/70 是否穩定？
   否 → 修錨點
   是 → 進 2

2) 單一屬性能否打中基準？
   否 → 調整對應錨點
   是 → 進 3

3) 問題是否出在混合組合？
   是 → 迭代優化
   否 → 檢查交互效應
```

### 11. 投手模型特則（與打者相容）
- STUFF 僅在「已接觸」後調整「接觸→安打率」（不動 K%）。
- 投手 OVR 權重：CONTROL 25%、STRIKEOUT 35%、STUFF 25%、SUPPRESSION 15%。
- 定義：屬性 70 為聯盟平均（與常數表錨點對齊）。


## 二、介面與體驗（UX/UI）設計原則

- 設計風格：極簡、功能導向、不使用 emoji、文字以繁體中文。
- 色彩系統：主色綠（#4ecdc4）並與既有設計一致。
- 交互：狀態反饋清晰、操作直覺、響應式設計。
- 按鈕：沿用既有樣式與語言，避免過度裝飾。


## 三、語言與編碼

- 預設語言：繁體中文。
- 編碼：UTF-8。
- 註解允許保留既有亂碼，但新內容應避免再次產生亂碼；若發現，請於 PR 描述備註並逐步清理。


## 四、變更管理與提交流程

- 任一參數或錨點變更需附測試證明，包含：為何、修改內容、期望、實際驗證。
- 變更範圍盡量單一化，避免同時修改多處造成歧義。
- 新增或調整常數需標記來源與適用範圍（例：年份區間、樣本數）。


## 五、實作落地（本專案當前狀態）

- 常數與工具：已於 `src/js/constants.js` 補上投手 attr→stat、聯盟平均、OVR 計算與調整器；與打者模型相容。
- UI 結構：首頁已改為「打者 / 投手」雙分頁視覺；投手頁暫為占位，後續接上模型輸出 BB%、K%、被BA、被SLG 與 OVR。
- 後續任務：
  - 在模擬引擎加入「可選投手輸入」的對戰模式與融合策略（BB/K 用對數機率合成或權重平均；STUFF/壓制依本文件規範）。
  - 依本文件之測試標準建立自動化測試腳本與報表（至少涵蓋 70/70/70、40/40/40、100/100/100，以及三項基準驗證）。


---

本文件為決策與檢查清單之唯一依據。後續若有新實證或需求變化，先評估是否影響基準；若不影響，優先調整錨點與交互參數，並完整記錄變更原因與測試證據。
