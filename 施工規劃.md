# 新打擊模擬系統重構施工規劃

> **項目名稱**: 四象限+兩階段打擊模擬系統
> **開始時間**: 2025-08-29
> **預計工期**: 5-7天
> **風險等級**: 中等

## 🎯 重構目標

### 核心改進
1. **簡化模擬邏輯**: 複雜S-curve → 清晰四象限
2. **統一參數控制**: 8個職責明確的插值表
3. **高性能設計**: 單球決勝負，支持3000打席<2秒
4. **真實XBH分配**: 解決當前XBH%不合理問題
5. **屬性交互平衡**: HIT-POW自然相互依賴

### 新系統特性
- **四象限擊球**: 高/低品質 × 高飛球/滾地球
- **兩階段長打**: XBH機率 → HR/2B分配
- **統一HIT效果**: 所有負面效果用同一公式
- **1-500屬性範圍**: 40-150人類極限，其餘平滑過渡

---

## 📋 施工階段規劃

### 🔥 階段1: 核心重建 (2-3天)
**目標**: 建立新系統核心邏輯

#### 1.1 新建常數表系統
- [ ] `new_constants.js` - 8個統一插值表
  - [ ] `EYE_BB_RATE_TABLE` (保送率)
  - [ ] `EYE_EFFECT_TABLE` (揮空減少)
  - [ ] `HIT_CONTACT_RATE_TABLE` (總接觸率)
  - [ ] `HIT_QUALITY_RATIO_TABLE` (品質接觸比例)
  - [ ] `HIT_EFFECT_TABLE` (負面效果減少)
  - [ ] `POW_FLYBALL_RATE_TABLE` (高飛球率)
  - [ ] `POW_XBH_RATE_TABLE` (總長打率)
  - [ ] `POW_HR_XBH_RATIO_TABLE` (HR/XBH比例)

#### 1.2 新建模擬引擎
- [ ] `new_probability_model.js` - 四象限系統
  - [ ] 統一插值函數
  - [ ] HIT效果應用函數
  - [ ] 四象限擊球判定
  - [ ] 兩階段XBH分配
  - [ ] 單球完整模擬流程

#### 1.3 基礎驗證
- [ ] 屬性→統計轉換測試
- [ ] Level 100精確性驗證
- [ ] 極端值邊界測試

### ⚙️ 階段2: 整合測試 (1-2天)
**目標**: 整合新系統到現有架構

#### 2.1 更新模擬引擎
- [ ] 修改 `simulation_engine.js`
  - [ ] 移除HBP、IPO事件類型
  - [ ] 更新為6種結果: BB/K/HR/2B/1B/OUT
  - [ ] 修正累積機率邏輯
  - [ ] 統計計算更新

#### 2.2 建立驗證工具
- [ ] `migration_verification.js` (臨時)
  - [ ] 新舊系統結果比較
  - [ ] MLB基準達成度檢查
  - [ ] 屬性效果隔離測試
- [ ] 更新測試案例
  - [ ] Level 40/70/100測試
  - [ ] 極端組合測試
  - [ ] 性能基準測試

### 🔄 階段3: 系統更新 (1天)
**目標**: 更新所有依賴檔案

#### 3.1 主要檔案更新
- [ ] `main.js` - 更新函數調用
- [ ] `ovr_calculator.js` - 屬性轉換校準
- [ ] `quick_test.js` - 驗證邏輯更新

#### 3.2 測試檔案群更新
- [ ] `test_eye.html` - EYE效果測試
- [ ] `test_hit.html` - HIT效果測試  
- [ ] `test_pow.html` - POW效果測試
- [ ] 其他測試檔案更新

### ✅ 階段4: 驗證清理 (1天)
**目標**: 全面測試並部署

#### 4.1 全面驗證
- [ ] 功能測試: 所有UI功能正常
- [ ] 精確度測試: MLB基準達成
- [ ] 性能測試: 3000打席<2秒
- [ ] 邊界測試: 極端值不崩潰
- [ ] 回歸測試: 不影響其他功能

#### 4.2 清理部署
- [ ] 備份舊檔案到 `legacy_old/`
- [ ] 部署新系統檔案
- [ ] 刪除臨時驗證檔案
- [ ] 更新文檔

---

## 📊 檔案影響清單

### 🔥 完全重寫 (2個)
| 檔案 | 原因 | 預計行數 |
|------|------|----------|
| `constants.js` | S-curve→插值表 | 150→100 |
| `probability_model.js` | 複雜→四象限 | 211→100 |

### ⚙️ 中度修改 (3個)
| 檔案 | 修改內容 | 影響程度 |
|------|----------|----------|
| `simulation_engine.js` | 事件類型更新 | 30% |
| `ovr_calculator.js` | 屬性轉換校準 | 20% |
| 測試檔案群 | 測試案例更新 | 50% |

### 🔧 輕度修改 (2個)
| 檔案 | 修改內容 | 影響程度 |
|------|----------|----------|
| `main.js` | 函數調用更新 | 10% |
| `quick_test.js` | 驗證邏輯更新 | 20% |

### ➕ 新增檔案 (1-2個)
- `new_constants.js` (永久)
- `new_probability_model.js` (永久)
- `migration_verification.js` (臨時)

---

## ⚠️ 風險控制

### 高風險點
1. **精確度風險**: Level 100可能不準確
   - **緩解**: 建立完整驗證測試套件
2. **性能風險**: 新系統可能較慢
   - **緩解**: 預計算+查表優化
3. **兼容性風險**: 可能影響其他功能
   - **緩解**: 詳細回歸測試

### 回滾計畫
- 保留完整舊系統備份
- 可隨時切回 `legacy/` 版本
- 準備快速部署腳本

---

## 🎯 成功指標

### 功能指標
- [ ] Level 100 球員精確達到MLB pr99統計
- [ ] XBH%分配合理 (包含適量2B)
- [ ] 四象限邏輯符合棒球現實

### 性能指標  
- [ ] 3000打席模擬 < 2秒
- [ ] 單次屬性轉換 < 0.1秒
- [ ] UI響應流暢無卡頓

### 品質指標
- [ ] 程式碼行數減少30%+
- [ ] 邏輯清晰易維護
- [ ] 8個表職責明確

---

## 🚀 開始實施

**Ready to Rock! 讓我們開始這場重構之旅！** 🎸

第一步：建立 `new_constants.js`，定義8個統一插值表...