<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wOBA Anchor Calibration Test</title>
    <script src="src/js/constants.js"></script>
    <script src="src/js/probability_model.js"></script>
    <script src="src/js/simulation_engine.js"></script>
    <style>
        body { font-family: monospace; margin: 20px; }
        table { border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f5f5f5; }
        .anchor { background-color: #ffffcc; font-weight: bold; }
        .section { margin: 30px 0; border: 1px solid #ddd; padding: 20px; }
        .chart { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>wOBA Anchor Point Calibration</h1>
    <p>æ‰¾å‡ºå„èƒ½åŠ›ç­‰ç´šå°æ‡‰çš„ wOBA å€¼ï¼Œå»ºç«‹ wOBA â†’ OVR æ˜ å°„å‡½æ•¸</p>
    
    <div id="results"></div>

    <script>
        function calculateWOBA(stats) {
            // MLB 2019-2021 average weights
            const weights = {
                BB: 0.692,
                '1B': 0.879, 
                '2B': 1.242,
                '3B': 1.568,
                HR: 2.081
            };
            
            const plateAppearances = stats.AB + stats.BB + stats.HBP;
            if (plateAppearances === 0) return 0;
            
            // å¾æ¨¡æ“¬çµæœè¨ˆç®—å„ç¨®å®‰æ‰“é¡å‹
            const hits = Math.round(stats.H);
            const doubles = Math.round(stats['2B'] || 0);
            const triples = Math.round(stats['3B'] || 0);  
            const homers = Math.round(stats.HR_count || 0);
            const singles = Math.max(0, hits - doubles - triples - homers);
            const walks = Math.round(stats.BB);
            
            const woba = (walks * weights.BB + 
                         singles * weights['1B'] + 
                         doubles * weights['2B'] + 
                         triples * weights['3B'] + 
                         homers * weights.HR) / plateAppearances;
                         
            return woba;
        }
        
        function runAnchorCalibration() {
            const results = [];
            
            console.log('ğŸ¯ wOBA Anchor Point Calibration Test');
            
            // Test 1: æ‰¾å‡ºå„ç­‰ç´šçš„ wOBA éŒ¨é»
            results.push('<div class="section"><h2>Step 1: èƒ½åŠ›ç­‰ç´š wOBA éŒ¨é»æ¸¬è©¦</h2>');
            
            const anchorLevels = [40, 70, 100, 120, 150];
            const anchorData = [];
            
            results.push('<h3>å‡è¡¡çƒå“¡ (POW=HIT=EYE) wOBA æ¸¬è©¦:</h3>');
            results.push('<table><tr><th>èƒ½åŠ›ç­‰ç´š</th><th>å±¬æ€§</th><th>æ¨¡æ“¬ wOBA</th><th>æ¨¡æ“¬ OPS</th><th>åˆ†ç´š</th></tr>');
            
            anchorLevels.forEach(level => {
                const stats = simulatePlayerStats(level, level, level, 100, 600);
                const woba = calculateWOBA(stats);
                const ops = stats.OBP + stats.SLG;
                
                let tier = '';
                if (level === 40) tier = 'é‚Šç·£çƒå“¡';
                else if (level === 70) tier = 'è¯ç›Ÿå¹³å‡';
                else if (level === 100) tier = 'ç²¾è‹±çƒå“¡';  
                else if (level === 120) tier = 'åäººå ‚';
                else if (level === 150) tier = 'æ­·å²å‚³å¥‡';
                
                results.push(
                    `<tr class="anchor"><td>${level}</td><td>${level}/${level}/${level}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>${ops.toFixed(3)}</td><td>${tier}</td></tr>`
                );
                
                anchorData.push({ level, woba, ops, tier });
                
                console.log(`LVL ${level}: wOBA=${woba.toFixed(3)}, OPS=${ops.toFixed(3)}`);
            });
            results.push('</table>');
            
            // Test 2: wOBA ç¯„åœæ¸¬è©¦
            results.push('<h3>wOBA åˆ†ä½ˆç¯„åœæ¸¬è©¦:</h3>');
            results.push('<table><tr><th>çƒå“¡é¡å‹</th><th>å±¬æ€§</th><th>wOBA</th><th>æ‡‰è©²å°æ‡‰ç­‰ç´š</th></tr>');
            
            const testPlayers = [
                { name: 'æ¥µç«¯å¼±åŒ–', pow: 30, hit: 30, eye: 30 },
                { name: 'å°è¯ç›Ÿ', pow: 50, hit: 50, eye: 50 },
                { name: 'æ›¿è£œçƒå“¡', pow: 60, hit: 60, eye: 60 },
                { name: 'æ™®é€šå…ˆç™¼', pow: 80, hit: 80, eye: 80 },
                { name: 'å„ªè³ªçƒå“¡', pow: 90, hit: 90, eye: 90 },
                { name: 'å…¨æ˜æ˜Ÿ', pow: 110, hit: 110, eye: 110 },
                { name: 'è¶…ç´šå·¨æ˜Ÿ', pow: 130, hit: 130, eye: 130 },
                { name: 'æ­·å²ç´š', pow: 160, hit: 160, eye: 160 }
            ];
            
            testPlayers.forEach(player => {
                const stats = simulatePlayerStats(player.pow, player.hit, player.eye, 50, 600);
                const woba = calculateWOBA(stats);
                
                // æ‰¾å‡ºæ‡‰è©²å°æ‡‰çš„ç­‰ç´š
                let expectedLevel = 40;
                for (let i = 0; i < anchorData.length - 1; i++) {
                    if (woba >= anchorData[i].woba && woba < anchorData[i + 1].woba) {
                        expectedLevel = anchorData[i].level + 
                            (anchorData[i + 1].level - anchorData[i].level) * 
                            (woba - anchorData[i].woba) / (anchorData[i + 1].woba - anchorData[i].woba);
                        break;
                    }
                }
                
                results.push(
                    `<tr><td>${player.name}</td><td>${player.pow}/${player.hit}/${player.eye}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>~${expectedLevel.toFixed(0)}</td></tr>`
                );
            });
            results.push('</table></div>');
            
            // Test 3: æ¥µç«¯å°ˆç²¾çƒå“¡æ¸¬è©¦
            results.push('<div class="section"><h2>Step 2: æ¥µç«¯å°ˆç²¾çƒå“¡ wOBA æ¸¬è©¦</h2>');
            results.push('<p>æ¸¬è©¦æ¥µç«¯å°ˆç²¾çƒå“¡çš„ wOBA å€¼æ˜¯å¦èƒ½åˆç†æ˜ å°„åˆ° OVR</p>');
            
            const specialistPlayers = [
                { name: 'æ¥µç«¯é•·æ‰“æ‰‹', pow: 150, hit: 50, eye: 50 },
                { name: 'æ¥µç«¯æ¥è§¸å‹', pow: 50, hit: 150, eye: 50 },
                { name: 'æ¥µç«¯é¸çƒå‹', pow: 50, hit: 50, eye: 150 },
                { name: 'é•·æ‰“+æ¥è§¸', pow: 130, hit: 130, eye: 60 },
                { name: 'æ¥è§¸+é¸çƒ', pow: 60, hit: 130, eye: 130 },
                { name: 'é•·æ‰“+é¸çƒ', pow: 130, hit: 60, eye: 130 }
            ];
            
            results.push('<table><tr><th>çƒå“¡é¡å‹</th><th>å±¬æ€§</th><th>wOBA</th><th>å°æ‡‰ç­‰ç´š</th><th>vs åŒç­‰ç´šå‡è¡¡çƒå“¡</th></tr>');
            
            specialistPlayers.forEach(player => {
                const stats = simulatePlayerStats(player.pow, player.hit, player.eye, 50, 600);
                const woba = calculateWOBA(stats);
                
                // æ‰¾å‡ºå°æ‡‰ç­‰ç´šå’ŒåŒç­‰ç´šå‡è¡¡çƒå“¡æ¯”è¼ƒ
                let correspondingLevel = 40;
                let balancedWOBA = 0;
                
                for (let i = 0; i < anchorData.length - 1; i++) {
                    if (woba >= anchorData[i].woba && woba <= anchorData[i + 1].woba) {
                        correspondingLevel = anchorData[i].level + 
                            (anchorData[i + 1].level - anchorData[i].level) * 
                            (woba - anchorData[i].woba) / (anchorData[i + 1].woba - anchorData[i].woba);
                        
                        // æ‰¾æœ€æ¥è¿‘çš„éŒ¨é»
                        const nearestAnchor = anchorData.reduce((prev, curr) => 
                            Math.abs(curr.level - correspondingLevel) < Math.abs(prev.level - correspondingLevel) ? curr : prev
                        );
                        balancedWOBA = nearestAnchor.woba;
                        break;
                    }
                }
                
                const comparison = woba > balancedWOBA ? `+${((woba - balancedWOBA) * 1000).toFixed(0)}` : 
                                  `${((woba - balancedWOBA) * 1000).toFixed(0)}`;
                
                results.push(
                    `<tr><td>${player.name}</td><td>${player.pow}/${player.hit}/${player.eye}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>~${correspondingLevel.toFixed(0)}</td><td>${comparison}</td></tr>`
                );
            });
            results.push('</table></div>');
            
            // Test 4: wOBA â†’ OVR æ˜ å°„å‡½æ•¸è¨­è¨ˆ
            results.push('<div class="section"><h2>Step 3: wOBA â†’ OVR æ˜ å°„å‡½æ•¸</h2>');
            
            const wobaRange = anchorData.map(d => d.woba);
            const minWOBA = Math.min(...wobaRange);
            const maxWOBA = Math.max(...wobaRange);
            
            results.push(`<p><strong>éŒ¨é» wOBA ç¯„åœ:</strong></p>`);
            results.push(`<ul>`);
            anchorData.forEach(anchor => {
                results.push(`<li>LVL ${anchor.level} (${anchor.tier}): wOBA = ${anchor.woba.toFixed(3)}</li>`);
            });
            results.push(`</ul>`);
            
            results.push(`<p><strong>å»ºè­°çš„ wOBA â†’ OVR æ˜ å°„å‡½æ•¸:</strong></p>`);
            results.push(`<pre>
function calculateOVRFromWOBA(woba) {
    // éŒ¨é»æ•¸æ“š
    const anchors = [
        { woba: ${anchorData[0].woba.toFixed(3)}, ovr: 40 },  // é‚Šç·£çƒå“¡
        { woba: ${anchorData[1].woba.toFixed(3)}, ovr: 70 },  // è¯ç›Ÿå¹³å‡  
        { woba: ${anchorData[2].woba.toFixed(3)}, ovr: 100 }, // ç²¾è‹±çƒå“¡
        { woba: ${anchorData[3].woba.toFixed(3)}, ovr: 120 }, // åäººå ‚
        { woba: ${anchorData[4].woba.toFixed(3)}, ovr: 150 }  // æ­·å²å‚³å¥‡
    ];
    
    // ç·šæ€§æ’å€¼
    for (let i = 0; i < anchors.length - 1; i++) {
        if (woba >= anchors[i].woba && woba <= anchors[i + 1].woba) {
            const ratio = (woba - anchors[i].woba) / (anchors[i + 1].woba - anchors[i].woba);
            return anchors[i].ovr + ratio * (anchors[i + 1].ovr - anchors[i].ovr);
        }
    }
    
    // é‚Šç•Œå¤–æ¨
    if (woba < anchors[0].woba) return Math.max(1, 40 * (woba / anchors[0].woba));
    if (woba > anchors[4].woba) return Math.min(200, 150 * (woba / anchors[4].woba));
    
    return 40; // é è¨­å€¼
}
</pre>`);
            results.push('</div>');
            
            document.getElementById('results').innerHTML = results.join('');
            console.log('âœ… wOBA Anchor Calibration Complete');
            
            return anchorData;
        }
        
        // Run test when page loads
        window.addEventListener('load', runAnchorCalibration);
    </script>
</body>
</html>