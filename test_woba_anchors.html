<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wOBA Anchor Calibration Test</title>
    <script src="src/js/constants.js"></script>
    <script src="src/js/probability_model.js"></script>
    <script src="src/js/simulation_engine.js"></script>
    <style>
        body { font-family: monospace; margin: 20px; }
        table { border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f5f5f5; }
        .anchor { background-color: #ffffcc; font-weight: bold; }
        .section { margin: 30px 0; border: 1px solid #ddd; padding: 20px; }
        .chart { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>wOBA Anchor Point Calibration</h1>
    <p>找出各能力等級對應的 wOBA 值，建立 wOBA → OVR 映射函數</p>
    
    <div id="results"></div>

    <script>
        function calculateWOBA(stats) {
            // MLB 2019-2021 average weights
            const weights = {
                BB: 0.692,
                '1B': 0.879, 
                '2B': 1.242,
                '3B': 1.568,
                HR: 2.081
            };
            
            const plateAppearances = stats.AB + stats.BB + stats.HBP;
            if (plateAppearances === 0) return 0;
            
            // 從模擬結果計算各種安打類型
            const hits = Math.round(stats.H);
            const doubles = Math.round(stats['2B'] || 0);
            const triples = Math.round(stats['3B'] || 0);  
            const homers = Math.round(stats.HR_count || 0);
            const singles = Math.max(0, hits - doubles - triples - homers);
            const walks = Math.round(stats.BB);
            
            const woba = (walks * weights.BB + 
                         singles * weights['1B'] + 
                         doubles * weights['2B'] + 
                         triples * weights['3B'] + 
                         homers * weights.HR) / plateAppearances;
                         
            return woba;
        }
        
        function runAnchorCalibration() {
            const results = [];
            
            console.log('🎯 wOBA Anchor Point Calibration Test');
            
            // Test 1: 找出各等級的 wOBA 錨點
            results.push('<div class="section"><h2>Step 1: 能力等級 wOBA 錨點測試</h2>');
            
            const anchorLevels = [40, 70, 100, 120, 150];
            const anchorData = [];
            
            results.push('<h3>均衡球員 (POW=HIT=EYE) wOBA 測試:</h3>');
            results.push('<table><tr><th>能力等級</th><th>屬性</th><th>模擬 wOBA</th><th>模擬 OPS</th><th>分級</th></tr>');
            
            anchorLevels.forEach(level => {
                const stats = simulatePlayerStats(level, level, level, 100, 600);
                const woba = calculateWOBA(stats);
                const ops = stats.OBP + stats.SLG;
                
                let tier = '';
                if (level === 40) tier = '邊緣球員';
                else if (level === 70) tier = '聯盟平均';
                else if (level === 100) tier = '精英球員';  
                else if (level === 120) tier = '名人堂';
                else if (level === 150) tier = '歷史傳奇';
                
                results.push(
                    `<tr class="anchor"><td>${level}</td><td>${level}/${level}/${level}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>${ops.toFixed(3)}</td><td>${tier}</td></tr>`
                );
                
                anchorData.push({ level, woba, ops, tier });
                
                console.log(`LVL ${level}: wOBA=${woba.toFixed(3)}, OPS=${ops.toFixed(3)}`);
            });
            results.push('</table>');
            
            // Test 2: wOBA 範圍測試
            results.push('<h3>wOBA 分佈範圍測試:</h3>');
            results.push('<table><tr><th>球員類型</th><th>屬性</th><th>wOBA</th><th>應該對應等級</th></tr>');
            
            const testPlayers = [
                { name: '極端弱化', pow: 30, hit: 30, eye: 30 },
                { name: '小聯盟', pow: 50, hit: 50, eye: 50 },
                { name: '替補球員', pow: 60, hit: 60, eye: 60 },
                { name: '普通先發', pow: 80, hit: 80, eye: 80 },
                { name: '優質球員', pow: 90, hit: 90, eye: 90 },
                { name: '全明星', pow: 110, hit: 110, eye: 110 },
                { name: '超級巨星', pow: 130, hit: 130, eye: 130 },
                { name: '歷史級', pow: 160, hit: 160, eye: 160 }
            ];
            
            testPlayers.forEach(player => {
                const stats = simulatePlayerStats(player.pow, player.hit, player.eye, 50, 600);
                const woba = calculateWOBA(stats);
                
                // 找出應該對應的等級
                let expectedLevel = 40;
                for (let i = 0; i < anchorData.length - 1; i++) {
                    if (woba >= anchorData[i].woba && woba < anchorData[i + 1].woba) {
                        expectedLevel = anchorData[i].level + 
                            (anchorData[i + 1].level - anchorData[i].level) * 
                            (woba - anchorData[i].woba) / (anchorData[i + 1].woba - anchorData[i].woba);
                        break;
                    }
                }
                
                results.push(
                    `<tr><td>${player.name}</td><td>${player.pow}/${player.hit}/${player.eye}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>~${expectedLevel.toFixed(0)}</td></tr>`
                );
            });
            results.push('</table></div>');
            
            // Test 3: 極端專精球員測試
            results.push('<div class="section"><h2>Step 2: 極端專精球員 wOBA 測試</h2>');
            results.push('<p>測試極端專精球員的 wOBA 值是否能合理映射到 OVR</p>');
            
            const specialistPlayers = [
                { name: '極端長打手', pow: 150, hit: 50, eye: 50 },
                { name: '極端接觸型', pow: 50, hit: 150, eye: 50 },
                { name: '極端選球型', pow: 50, hit: 50, eye: 150 },
                { name: '長打+接觸', pow: 130, hit: 130, eye: 60 },
                { name: '接觸+選球', pow: 60, hit: 130, eye: 130 },
                { name: '長打+選球', pow: 130, hit: 60, eye: 130 }
            ];
            
            results.push('<table><tr><th>球員類型</th><th>屬性</th><th>wOBA</th><th>對應等級</th><th>vs 同等級均衡球員</th></tr>');
            
            specialistPlayers.forEach(player => {
                const stats = simulatePlayerStats(player.pow, player.hit, player.eye, 50, 600);
                const woba = calculateWOBA(stats);
                
                // 找出對應等級和同等級均衡球員比較
                let correspondingLevel = 40;
                let balancedWOBA = 0;
                
                for (let i = 0; i < anchorData.length - 1; i++) {
                    if (woba >= anchorData[i].woba && woba <= anchorData[i + 1].woba) {
                        correspondingLevel = anchorData[i].level + 
                            (anchorData[i + 1].level - anchorData[i].level) * 
                            (woba - anchorData[i].woba) / (anchorData[i + 1].woba - anchorData[i].woba);
                        
                        // 找最接近的錨點
                        const nearestAnchor = anchorData.reduce((prev, curr) => 
                            Math.abs(curr.level - correspondingLevel) < Math.abs(prev.level - correspondingLevel) ? curr : prev
                        );
                        balancedWOBA = nearestAnchor.woba;
                        break;
                    }
                }
                
                const comparison = woba > balancedWOBA ? `+${((woba - balancedWOBA) * 1000).toFixed(0)}` : 
                                  `${((woba - balancedWOBA) * 1000).toFixed(0)}`;
                
                results.push(
                    `<tr><td>${player.name}</td><td>${player.pow}/${player.hit}/${player.eye}</td>` +
                    `<td>${woba.toFixed(3)}</td><td>~${correspondingLevel.toFixed(0)}</td><td>${comparison}</td></tr>`
                );
            });
            results.push('</table></div>');
            
            // Test 4: wOBA → OVR 映射函數設計
            results.push('<div class="section"><h2>Step 3: wOBA → OVR 映射函數</h2>');
            
            const wobaRange = anchorData.map(d => d.woba);
            const minWOBA = Math.min(...wobaRange);
            const maxWOBA = Math.max(...wobaRange);
            
            results.push(`<p><strong>錨點 wOBA 範圍:</strong></p>`);
            results.push(`<ul>`);
            anchorData.forEach(anchor => {
                results.push(`<li>LVL ${anchor.level} (${anchor.tier}): wOBA = ${anchor.woba.toFixed(3)}</li>`);
            });
            results.push(`</ul>`);
            
            results.push(`<p><strong>建議的 wOBA → OVR 映射函數:</strong></p>`);
            results.push(`<pre>
function calculateOVRFromWOBA(woba) {
    // 錨點數據
    const anchors = [
        { woba: ${anchorData[0].woba.toFixed(3)}, ovr: 40 },  // 邊緣球員
        { woba: ${anchorData[1].woba.toFixed(3)}, ovr: 70 },  // 聯盟平均  
        { woba: ${anchorData[2].woba.toFixed(3)}, ovr: 100 }, // 精英球員
        { woba: ${anchorData[3].woba.toFixed(3)}, ovr: 120 }, // 名人堂
        { woba: ${anchorData[4].woba.toFixed(3)}, ovr: 150 }  // 歷史傳奇
    ];
    
    // 線性插值
    for (let i = 0; i < anchors.length - 1; i++) {
        if (woba >= anchors[i].woba && woba <= anchors[i + 1].woba) {
            const ratio = (woba - anchors[i].woba) / (anchors[i + 1].woba - anchors[i].woba);
            return anchors[i].ovr + ratio * (anchors[i + 1].ovr - anchors[i].ovr);
        }
    }
    
    // 邊界外推
    if (woba < anchors[0].woba) return Math.max(1, 40 * (woba / anchors[0].woba));
    if (woba > anchors[4].woba) return Math.min(200, 150 * (woba / anchors[4].woba));
    
    return 40; // 預設值
}
</pre>`);
            results.push('</div>');
            
            document.getElementById('results').innerHTML = results.join('');
            console.log('✅ wOBA Anchor Calibration Complete');
            
            return anchorData;
        }
        
        // Run test when page loads
        window.addEventListener('load', runAnchorCalibration);
    </script>
</body>
</html>