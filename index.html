<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£’çƒèƒ½åŠ›å€¼é›™å‘è½‰æ›è¨ˆç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }
        
        .calculator-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .calculator-section:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-top: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #4ecdc4;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: bold;
            color: #555;
        }
        
        .result-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .ovr-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .ovr-number {
            font-size: 3em;
            font-weight: bold;
            color: #2d3436;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .ovr-label {
            font-size: 1.2em;
            color: #636e72;
            margin-top: 10px;
        }
        
        .icon {
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
        
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¾ æ£’çƒèƒ½åŠ›å€¼é›™å‘è½‰æ›è¨ˆç®—å™¨</h1>
            <p>åŸºæ–¼ POW/HIT/EYE ä¸‰åœç³»çµ±çš„æ£’çƒæ•¸æ“šé æ¸¬å·¥å…·</p>
        </div>
        
        <div class="main-content">
            <!-- æ•¸æ“šè½‰ä¸‰åœ -->
            <div class="calculator-section">
                <h2 class="section-title">
                    <span class="icon">ğŸ“Š</span>
                    æ•¸æ“š â†’ ä¸‰åœ + OVR
                </h2>
                
                <div class="input-group">
                    <label for="xBA">é æœŸæ‰“æ“Šç‡ (xBA)</label>
                    <input type="number" id="xBA" step="0.001" placeholder="ä¾‹å¦‚: 0.280" min="0" max="1">
                    <div class="help-text">é€šå¸¸åœ¨ 0.200 - 0.350 ä¹‹é–“</div>
                </div>
                
                <div class="input-group">
                    <label for="xSLG">é æœŸé•·æ‰“ç‡ (xSLG)</label>
                    <input type="number" id="xSLG" step="0.001" placeholder="ä¾‹å¦‚: 0.450" min="0" max="1">
                    <div class="help-text">é€šå¸¸åœ¨ 0.300 - 0.700 ä¹‹é–“</div>
                </div>
                
                <div class="input-group">
                    <label for="xwOBA">é æœŸåŠ æ¬Šä¸Šå£˜ç‡ (xwOBA)</label>
                    <input type="number" id="xwOBA" step="0.001" placeholder="ä¾‹å¦‚: 0.350" min="0" max="1">
                    <div class="help-text">é€šå¸¸åœ¨ 0.250 - 0.450 ä¹‹é–“</div>
                </div>
                
                <button class="button" onclick="calculateAttributes()">
                    è¨ˆç®—ä¸‰åœ + OVR
                </button>
                
                <div id="attributeResults" class="results" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">ğŸ’ª POW (Power)</span>
                        <span class="result-value" id="powResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ¯ HIT (Hit Tool)</span>
                        <span class="result-value" id="hitResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ‘ï¸ EYE (Plate Discipline)</span>
                        <span class="result-value" id="eyeResult">-</span>
                    </div>
                    
                    <div class="ovr-display">
                        <div class="ovr-number" id="ovrFromStats">-</div>
                        <div class="ovr-label">Overall Rating (OVR)</div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‰åœè½‰æ•¸æ“š -->
            <div class="calculator-section">
                <h2 class="section-title">
                    <span class="icon">âš™ï¸</span>
                    ä¸‰åœ â†’ é æ¸¬æ•¸æ“š
                </h2>
                
                <div class="input-group">
                    <label for="inputPOW">POW (Power)</label>
                    <input type="number" id="inputPOW" placeholder="ä¾‹å¦‚: 85" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputHIT">HIT (Hit Tool)</label>
                    <input type="number" id="inputHIT" placeholder="ä¾‹å¦‚: 75" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputEYE">EYE (Plate Discipline)</label>
                    <input type="number" id="inputEYE" placeholder="ä¾‹å¦‚: 80" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputPA">æ‰“å¸­æ•¸ (PA)</label>
                    <input type="number" id="inputPA" placeholder="ä¾‹å¦‚: 600" min="1" max="1000">
                    <div class="help-text">ä¸€å€‹å®Œæ•´è³½å­£é€šå¸¸ 500-700 æ‰“å¸­</div>
                </div>
                
                <button class="button" onclick="calculateStats()">
                    é æ¸¬æ•¸æ“š + OVR
                </button>
                
                <div id="statsResults" class="results" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">ğŸ“ˆ æ‰“æ“Šç‡ (BA)</span>
                        <span class="result-value" id="baResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸƒ ä¸Šå£˜ç‡ (OBP)</span>
                        <span class="result-value" id="obpResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ’¥ é•·æ‰“ç‡ (SLG)</span>
                        <span class="result-value" id="slgResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ”¥ OPS</span>
                        <span class="result-value" id="opsResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">âš¾ å…¨å£˜æ‰“</span>
                        <span class="result-value" id="hrResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ‘ï¸ ä¿é€ç‡</span>
                        <span class="result-value" id="bbRateResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸŒªï¸ ä¸‰æŒ¯ç‡</span>
                        <span class="result-value" id="kRateResult">-</span>
                    </div>
                    
                    <div class="ovr-display">
                        <div class="ovr-number" id="ovrFromAttributes">-</div>
                        <div class="ovr-label">Overall Rating (OVR)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¸¸æ•¸å®šç¾© (å¾ä½ çš„ game_constants.py è½‰æ›)
        const LEAGUE_BENCHMARKS = {
            'xBA': {'pr1': 0.200, 'pr50': 0.250, 'pr99': 0.330},
            'xSLG': {'pr1': 0.310, 'pr50': 0.400, 'pr99': 0.640},
            'xwOBA': {'pr1': 0.260, 'pr50': 0.320, 'pr99': 0.430}
        };
        
        const ATTRIBUTE_MAPPING_POINTS = {'pr1': 40, 'pr50': 70, 'pr99': 99};
        const SOFT_CAP_ATTRIBUTE_VALUE = 150.0;
        const ATTR_EFFECT_MIDPOINT = 70.0;
        
        // S-Curve éŒ¨é»
        const HR_S_CURVE_POW_ANCHORS = [
            [0, 0.0005], [30, 0.003], [40, 0.0067], [60, 0.020],
            [70, 0.0333], [85, 0.045], [99, 0.0580], [115, 0.072],
            [130, 0.0870], [140, 0.098], [150, 0.110]
        ];
        
        const BABIP_S_CURVE_HIT_ANCHORS = [
            [0, 0.215], [30, 0.245], [40, 0.270], [60, 0.295],
            [70, 0.305], [85, 0.330], [99, 0.350], [110, 0.365],
            [120, 0.375], [130, 0.385], [140, 0.395], [150, 0.405]
        ];
        
        const BB_S_CURVE_EYE_ANCHORS = [
            [0, 0.030], [30, 0.045], [40, 0.062], [60, 0.075],
            [70, 0.085], [85, 0.105], [99, 0.125], [115, 0.145],
            [130, 0.160], [140, 0.170], [150, 0.180]
        ];
        
        const K_EYE_EFFECTIVENESS_S_CURVE_ANCHORS = [
            [0, 0.8], [30, 0.5], [40, 0.3], [60, 0.1],
            [70, 0.0], [85, -0.20], [99, -0.40], [115, -0.55],
            [130, -0.70], [140, -0.75], [150, -0.80]
        ];
        
        // å¸¸æ•¸åƒæ•¸
        const AVG_K_RATE_AT_MIDPOINT = 0.220;
        const MIN_K_RATE_CAP = 0.080;
        const MAX_K_RATE_CAP = 0.350;
        const K_RATE_HIT_WEIGHT = 0.50;
        const K_RATE_EYE_WEIGHT = 0.50;
        const K_HIT_EFFECT_MIDPOINT = 70.0;
        const K_HIT_EFFECT_SCALE = 55.0;
        
        const AVG_2B_PER_HIT_BIP_NOT_HR_AT_MIDPOINT = 0.31;
        const MIN_2B_PER_HIT_BIP_NOT_HR = 0.22;
        const MAX_2B_PER_HIT_BIP_NOT_HR = 0.42;
        const EXTRABASE_POW_EFFECT_MIDPOINT = 70.0;
        const EXTRABASE_POW_EFFECT_SCALE = 48.0;
        const EXTRABASE_HIT_EFFECT_MIDPOINT = 70.0;
        const EXTRABASE_HIT_EFFECT_SCALE = 48.0;
        const EXTRABASE_POW_WEIGHT = 0.50;
        const EXTRABASE_HIT_WEIGHT = 0.50;
        
        const LEAGUE_AVG_HBP_RATE = 0.010;
        
        // æ•¸æ“šè½‰ä¸‰åœçš„å‡½æ•¸ï¼ˆç§»é™¤99çš„é™åˆ¶ï¼‰
        function calculatePlayerGameAttributes(xBA, xSLG, xwOBA) {
            const pr1_map = ATTRIBUTE_MAPPING_POINTS['pr1'];
            const pr50_map = ATTRIBUTE_MAPPING_POINTS['pr50'];
            const pr99_map = ATTRIBUTE_MAPPING_POINTS['pr99'];
            const delta_50_1 = pr50_map - pr1_map;
            const delta_99_50 = pr99_map - pr50_map;
            
            function getAttributeScore(metricVal, pr1Benchmark, pr50Benchmark, pr99Benchmark) {
                let score = 0;
                if (metricVal <= pr1Benchmark) {
                    score = pr1_map;
                } else if (metricVal <= pr50Benchmark) {
                    if ((pr50Benchmark - pr1Benchmark) === 0) {
                        score = pr50_map;
                    } else {
                        score = pr1_map + delta_50_1 * (metricVal - pr1Benchmark) / (pr50Benchmark - pr1Benchmark);
                    }
                } else if (metricVal <= pr99Benchmark) {
                    if ((pr99Benchmark - pr50Benchmark) === 0) {
                        score = pr99_map;
                    } else {
                        score = pr50_map + delta_99_50 * (metricVal - pr50Benchmark) / (pr99Benchmark - pr50Benchmark);
                    }
                } else {
                    // å…è¨±è¶…è¶ŠPR99ï¼é€™è£¡ä¸è¨­ä¸Šé™
                    if ((pr99Benchmark - pr50Benchmark) === 0) {
                        score = pr99_map;
                    } else {
                        const slope_pr50_pr99 = delta_99_50 / (pr99Benchmark - pr50Benchmark);
                        score = pr99_map + slope_pr50_pr99 * (metricVal - pr99Benchmark);
                    }
                }
                // åªè¨­æœ€ä½é™ï¼Œä¸è¨­ä¸Šé™ï¼Œè®“é ‚å°–çƒå“¡å¯ä»¥çªç ´99
                return Math.max(0, score);
            }
            
            const hitAttribute = getAttributeScore(xBA, LEAGUE_BENCHMARKS['xBA']['pr1'], LEAGUE_BENCHMARKS['xBA']['pr50'], LEAGUE_BENCHMARKS['xBA']['pr99']);
            const powAttribute = getAttributeScore(xSLG, LEAGUE_BENCHMARKS['xSLG']['pr1'], LEAGUE_BENCHMARKS['xSLG']['pr50'], LEAGUE_BENCHMARKS['xSLG']['pr99']);
            const eyeAttribute = getAttributeScore(xwOBA, LEAGUE_BENCHMARKS['xwOBA']['pr1'], LEAGUE_BENCHMARKS['xwOBA']['pr50'], LEAGUE_BENCHMARKS['xwOBA']['pr99']);
            
            return {POW: powAttribute, HIT: hitAttribute, EYE: eyeAttribute};
        }
        
        // S-curve æ’å€¼å‡½æ•¸
        function interpolateSCurve(value, anchors) {
            if (!anchors || anchors.length === 0) return 0.0;
            
            const cappedValue = Math.min(value, SOFT_CAP_ATTRIBUTE_VALUE * 1.1);
            
            if (cappedValue <= anchors[0][0]) {
                return anchors[0][1];
            }
            if (cappedValue >= anchors[anchors.length - 1][0]) {
                return anchors[anchors.length - 1][1];
            }
            
            for (let i = 0; i < anchors.length - 1; i++) {
                const [x1, y1] = anchors[i];
                const [x2, y2] = anchors[i + 1];
                if (x1 <= cappedValue && cappedValue < x2) {
                    if ((x2 - x1) === 0) return y1;
                    return y1 + (y2 - y1) * (cappedValue - x1) / (x2 - x1);
                }
            }
            
            return anchors[anchors.length - 1][1];
        }
        
        // å±¬æ€§æ•ˆèƒ½ç¸®æ”¾å‡½æ•¸
        function scaleAttributeToEffectiveness(attributeValue, midpoint, scale, effectIsPositive = true) {
            if (scale === 0) return 0.0;
            const normalizedValue = (attributeValue - midpoint) / scale;
            const tanhVal = Math.tanh(normalizedValue);
            return effectIsPositive ? tanhVal : -tanhVal;
        }
        
        // å¾æ•ˆèƒ½ç²å–æ¯”ç‡
        function getRateFromEffectiveness(baseRateAtMidpoint, minRate, maxRate, effectivenessFactor) {
            if (effectivenessFactor >= 0) {
                return baseRateAtMidpoint + effectivenessFactor * (maxRate - baseRateAtMidpoint);
            } else {
                return baseRateAtMidpoint + effectivenessFactor * (baseRateAtMidpoint - minRate);
            }
        }
        
        // è¨ˆç®— HR ç‡
        function calculateHRRateFromPowSCurve(POW) {
            return interpolateSCurve(POW, HR_S_CURVE_POW_ANCHORS);
        }
        
        // è¨ˆç®— BABIP
        function calculateBABIPFromHitSCurve(HIT) {
            const babip = interpolateSCurve(HIT, BABIP_S_CURVE_HIT_ANCHORS);
            return Math.max(0.190, Math.min(0.450, babip));
        }
        
        // è¨ˆç®— BB ç‡
        function calculateBBRateFromEyeSCurve(EYE) {
            const bbRate = interpolateSCurve(EYE, BB_S_CURVE_EYE_ANCHORS);
            return Math.max(0.020, Math.min(0.250, bbRate));
        }
        
        // è¨ˆç®— K ç‡
        function calculateKRateCombined(EYE, HIT) {
            const eyeKEffectiveness = interpolateSCurve(EYE, K_EYE_EFFECTIVENESS_S_CURVE_ANCHORS);
            const hitKEffectiveness = scaleAttributeToEffectiveness(HIT, K_HIT_EFFECT_MIDPOINT, K_HIT_EFFECT_SCALE, false);
            
            const combinedKEffectiveness = (K_RATE_EYE_WEIGHT * eyeKEffectiveness + K_RATE_HIT_WEIGHT * hitKEffectiveness);
            
            const kRate = getRateFromEffectiveness(AVG_K_RATE_AT_MIDPOINT, MIN_K_RATE_CAP, MAX_K_RATE_CAP, combinedKEffectiveness);
            return Math.max(MIN_K_RATE_CAP, Math.min(MAX_K_RATE_CAP, kRate));
        }
        
        // è¨ˆç®— PA äº‹ä»¶æ©Ÿç‡
        function getPAEventProbabilities(POW, HIT, EYE, playerHBPRate = LEAGUE_AVG_HBP_RATE) {
            // è¨ˆç®—åŸºæœ¬æ¯”ç‡
            const pK = calculateKRateCombined(EYE, HIT);
            const pBB = calculateBBRateFromEyeSCurve(EYE);
            const pHBP = Math.max(0.0, Math.min(0.05, playerHBPRate));
            
            // è¨ˆç®— HR ç‡
            let pHR = calculateHRRateFromPowSCurve(POW);
            
            // EYE å’Œ HIT å° HR çš„ä¿®æ­£
            const eyeEffHRMod = scaleAttributeToEffectiveness(EYE, 70.0, 40.0, true);
            const eyeModifier = 1.0 + (eyeEffHRMod * 0.12);
            
            const hitEffHRMod = scaleAttributeToEffectiveness(HIT, 70.0, 40.0, true);
            const hitModifier = 1.0 + (hitEffHRMod * 0.18);
            
            pHR = pHR * eyeModifier * hitModifier;
            pHR = Math.max(0.0, Math.min(pHR, 0.20));
            
            // è¨ˆç®—å‰©é¤˜ BIP æ©Ÿç‡
            const probSumNonBIPPlusHR = pK + pBB + pHBP + pHR;
            
            let p1B, p2B, pIPO;
            
            if (probSumNonBIPPlusHR >= 1.0) {
                const scaleDown = 1.0 / probSumNonBIPPlusHR;
                const scaledPK = pK * scaleDown;
                const scaledPBB = pBB * scaleDown;
                const scaledPHBP = pHBP * scaleDown;
                pHR = Math.max(0, 1.0 - (scaledPK + scaledPBB + scaledPHBP));
                
                p1B = 0.0;
                p2B = 0.0;
                pIPO = 0.0;
            } else {
                const pBIPForOtherOutcomes = 1.0 - probSumNonBIPPlusHR;
                const pHitGivenBIPRemaining = calculateBABIPFromHitSCurve(HIT);
                
                const pTotalHitsOnRemainingBIP = pBIPForOtherOutcomes * pHitGivenBIPRemaining;
                pIPO = Math.max(0, pBIPForOtherOutcomes * (1.0 - pHitGivenBIPRemaining));
                
                if (pTotalHitsOnRemainingBIP > 0) {
                    const powEffXBH = scaleAttributeToEffectiveness(POW, EXTRABASE_POW_EFFECT_MIDPOINT, EXTRABASE_POW_EFFECT_SCALE, true);
                    const hitEffXBH = scaleAttributeToEffectiveness(HIT, EXTRABASE_HIT_EFFECT_MIDPOINT, EXTRABASE_HIT_EFFECT_SCALE, true);
                    const combinedEffXBH = EXTRABASE_POW_WEIGHT * powEffXBH + EXTRABASE_HIT_WEIGHT * hitEffXBH;
                    
                    const p2BGivenHitBIPNotHR = getRateFromEffectiveness(
                        AVG_2B_PER_HIT_BIP_NOT_HR_AT_MIDPOINT,
                        MIN_2B_PER_HIT_BIP_NOT_HR,
                        MAX_2B_PER_HIT_BIP_NOT_HR,
                        combinedEffXBH
                    );
                    
                    p2B = Math.max(0, pTotalHitsOnRemainingBIP * p2BGivenHitBIPNotHR);
                    p1B = Math.max(0, pTotalHitsOnRemainingBIP * (1.0 - p2BGivenHitBIPNotHR));
                } else {
                    p1B = 0.0;
                    p2B = 0.0;
                }
            }
            
            return {
                HR: pHR,
                '2B': p2B,
                '1B': p1B,
                BB: pBB,
                HBP: pHBP,
                K: pK,
                IPO: pIPO
            };
        }
        
        // æ¨¡æ“¬ä¸€å€‹è³½å­£
        function simulateSeason(numPA, probabilities) {
            const outcomes = {
                HR: 0, '2B': 0, '1B': 0, BB: 0, HBP: 0, K: 0, IPO: 0,
                H: 0, AB: 0, PA: 0, OUT: 0
            };
            
            const eventOrder = ['HR', '2B', '1B', 'BB', 'HBP', 'K', 'IPO'];
            
            for (let i = 0; i < numPA; i++) {
                outcomes.PA += 1;
                const randVal = Math.random();
                let cumulativeProb = 0.0;
                let chosenEvent = 'IPO'; // é è¨­å€¼
                
                for (const eventType of eventOrder) {
                    const prob = probabilities[eventType] || 0;
                    cumulativeProb += prob;
                    if (randVal < cumulativeProb) {
                        chosenEvent = eventType;
                        break;
                    }
                }
                
                outcomes[chosenEvent] += 1;
                
                if (['HR', '2B', '1B'].includes(chosenEvent)) {
                    outcomes.H += 1;
                    outcomes.AB += 1;
                } else if (['K', 'IPO'].includes(chosenEvent)) {
                    outcomes.OUT += 1;
                    outcomes.AB += 1;
                }
            }
            
            return outcomes;
        }
        
        // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
        function calculateSimStats(simResults) {
            const stats = {};
            const ab = simResults.AB || 0;
            const h = simResults.H || 0;
            const bb = simResults.BB || 0;
            const hbp = simResults.HBP || 0;
            const pa = simResults.PA || 0;
            const k = simResults.K || 0;
            
            stats.BA = ab > 0 ? h / ab : 0;
            stats.OBP = pa > 0 ? (h + bb + hbp) / pa : 0;
            
            const tb = (simResults['1B'] || 0) * 1 + (simResults['2B'] || 0) * 2 + (simResults.HR || 0) * 4;
            stats.SLG = ab > 0 ? tb / ab : 0;
            stats.OPS = stats.OBP + stats.SLG;
            stats.K_rate = pa > 0 ? k / pa : 0;
            stats.BB_rate = pa > 0 ? bb / pa : 0;
            
            stats.HR_count = simResults.HR || 0;
            stats.BB_count = bb;
            stats.K_count = k;
            stats.H_count = h;
            stats.AB_count = ab;
            stats.PA_count = pa;
            
            return stats;
        }
        
        // åŸºæ–¼ä¸‰åœå’Œ xwOBA çš„ OVR è¨ˆç®—
        function calculateBatterOVR(pow, hit, eye, xwOBA = null) {
            // å¦‚æœæœ‰ xwOBAï¼Œå„ªå…ˆä½¿ç”¨å®ƒä½œç‚ºåŸºæº–
            if (xwOBA !== null) {
                // åŸºæ–¼ xwOBA çš„ OVR è¨ˆç®—
                // è¯ç›Ÿå¹³å‡ xwOBA â‰ˆ 0.320ï¼Œå°æ‡‰ OVR 70
                // xwOBA 0.250 â†’ OVR 50, xwOBA 0.400 â†’ OVR 90, xwOBA 0.450+ â†’ OVR 100+
                
                let baseOVR;
                if (xwOBA <= 0.250) {
                    baseOVR = 40 + (xwOBA - 0.200) / (0.250 - 0.200) * 10; // 40-50
                } else if (xwOBA <= 0.320) {
                    baseOVR = 50 + (xwOBA - 0.250) / (0.320 - 0.250) * 20; // 50-70
                } else if (xwOBA <= 0.400) {
                    baseOVR = 70 + (xwOBA - 0.320) / (0.400 - 0.320) * 20; // 70-90
                } else if (xwOBA <= 0.450) {
                    baseOVR = 90 + (xwOBA - 0.400) / (0.450 - 0.400) * 10; // 90-100
                } else {
                    // è¶…ç´šçƒå“¡å€é–“ï¼ŒxwOBA > 0.450
                    baseOVR = 100 + (xwOBA - 0.450) / 0.050 * 15; // 100+
                }
                
                // æ ¹æ“šä¸‰åœçš„æ¥µç«¯ç¨‹åº¦é€²è¡Œå¾®èª¿
                const avgAttribute = (pow + hit + eye) / 3;
                if (avgAttribute > 100) {
                    baseOVR += (avgAttribute - 100) * 0.2; // ä¸‰åœè¶…é100æ™‚é¡å¤–åŠ æˆ
                }
                
                return Math.round(Math.max(40, baseOVR));
            }
            
            // å¦‚æœæ²’æœ‰ xwOBAï¼Œä½¿ç”¨ä¸‰åœè¨ˆç®—
            // å°‡ä¸‰åœè½‰æ›ç‚ºç­‰æ•ˆçš„ xwOBAï¼Œç„¶å¾Œè¨ˆç®— OVR
            const weightedAvg = (pow * 0.35 + hit * 0.35 + eye * 0.30);
            
            // ä¸‰åœåˆ° xwOBA çš„æ˜ å°„
            let estimatedXwOBA;
            if (weightedAvg <= 40) {
                estimatedXwOBA = 0.200 + (weightedAvg - 30) / 10 * 0.050; // 0.200-0.250
            } else if (weightedAvg <= 70) {
                estimatedXwOBA = 0.250 + (weightedAvg - 40) / 30 * 0.070; // 0.250-0.320
            } else if (weightedAvg <= 99) {
                estimatedXwOBA = 0.320 + (weightedAvg - 70) / 29 * 0.080; // 0.320-0.400
            } else {
                // è¶…é99çš„è¶…ç´šçƒå“¡
                estimatedXwOBA = 0.400 + (weightedAvg - 99) / 20 * 0.100; // 0.400+
            }
            
            // éæ­¸èª¿ç”¨ï¼Œä½¿ç”¨ä¼°ç®—çš„ xwOBA
            return calculateBatterOVR(pow, hit, eye, estimatedXwOBA);
        }
        
        // æ•¸æ“šè½‰ä¸‰åœçš„ä¸»å‡½æ•¸
        function calculateAttributes() {
            const xBA = parseFloat(document.getElementById('xBA').value);
            const xSLG = parseFloat(document.getElementById('xSLG').value);
            const xwOBA = parseFloat(document.getElementById('xwOBA').value);
            
            if (!xBA || !xSLG || !xwOBA) {
                alert('è«‹å¡«å…¥æ‰€æœ‰æ•¸æ“šï¼');
                return;
            }
            
            if (xBA < 0 || xBA > 1 || xSLG < 0 || xSLG > 1 || xwOBA < 0 || xwOBA > 1) {
                alert('è«‹ç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½åœ¨ 0-1 ä¹‹é–“ï¼');
                return;
            }
            
            const attributes = calculatePlayerGameAttributes(xBA, xSLG, xwOBA);
            const ovr = calculateBatterOVR(attributes.POW, attributes.HIT, attributes.EYE, xwOBA);
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('powResult').textContent = attributes.POW.toFixed(1);
            document.getElementById('hitResult').textContent = attributes.HIT.toFixed(1);
            document.getElementById('eyeResult').textContent = attributes.EYE.toFixed(1);
            document.getElementById('ovrFromStats').textContent = ovr;
            
            document.getElementById('attributeResults').style.display = 'block';
        }
        
        // ä¸‰åœè½‰æ•¸æ“šçš„ä¸»å‡½æ•¸
        function calculateStats() {
            const pow = parseFloat(document.getElementById('inputPOW').value);
            const hit = parseFloat(document.getElementById('inputHIT').value);
            const eye = parseFloat(document.getElementById('inputEYE').value);
            const pa = parseInt(document.getElementById('inputPA').value);
            
            if (!pow || !hit || !eye || !pa) {
                alert('è«‹å¡«å…¥æ‰€æœ‰ä¸‰åœå’Œæ‰“å¸­æ•¸ï¼');
                return;
            }
            
            if (pow < 0 || hit < 0 || eye < 0 || pa < 1) {
                alert('è«‹ç¢ºä¿æ‰€æœ‰æ•¸å€¼éƒ½ç‚ºæ­£æ•¸ï¼');
                return;
            }
            
            // è¨ˆç®—äº‹ä»¶æ©Ÿç‡
            const eventProbs = getPAEventProbabilities(pow, hit, eye);
            
            // é€²è¡Œå¤šæ¬¡æ¨¡æ“¬å–å¹³å‡å€¼
            const numSimulations = 100;
            let totalStats = {
                BA: 0, OBP: 0, SLG: 0, OPS: 0, K_rate: 0, BB_rate: 0, HR_count: 0
            };
            
            for (let i = 0; i < numSimulations; i++) {
                const seasonResults = simulateSeason(pa, eventProbs);
                const stats = calculateSimStats(seasonResults);
                
                totalStats.BA += stats.BA;
                totalStats.OBP += stats.OBP;
                totalStats.SLG += stats.SLG;
                totalStats.OPS += stats.OPS;
                totalStats.K_rate += stats.K_rate;
                totalStats.BB_rate += stats.BB_rate;
                totalStats.HR_count += stats.HR_count;
            }
            
            // è¨ˆç®—å¹³å‡å€¼
            for (let key in totalStats) {
                totalStats[key] /= numSimulations;
            }
            
            // ä½¿ç”¨ä¸‰åœè¨ˆç®— OVRï¼ˆæ²’æœ‰ xwOBAï¼‰
            const ovr = calculateBatterOVR(pow, hit, eye, null);
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('baResult').textContent = totalStats.BA.toFixed(3);
            document.getElementById('obpResult').textContent = totalStats.OBP.toFixed(3);
            document.getElementById('slgResult').textContent = totalStats.SLG.toFixed(3);
            document.getElementById('opsResult').textContent = totalStats.OPS.toFixed(3);
            document.getElementById('hrResult').textContent = Math.round(totalStats.HR_count);
            document.getElementById('bbRateResult').textContent = (totalStats.BB_rate * 100).toFixed(1) + '%';
            document.getElementById('kRateResult').textContent = (totalStats.K_rate * 100).toFixed(1) + '%';
            document.getElementById('ovrFromAttributes').textContent = ovr;
            
            document.getElementById('statsResults').style.display = 'block';
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•¸æ“šæç¤º
            const examples = {
                // å¤§è°·ç¿”å¹³ 2024 çš„æ•¸æ“šä½œç‚ºç¤ºä¾‹
                xBA: 0.314,
                xSLG: 0.660,
                xwOBA: 0.431,
                POW: 93,
                HIT: 91,
                EYE: 93,
                PA: 731
            };
            
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æ›´å¤šçš„åˆå§‹åŒ–é‚è¼¯
            console.log('æ£’çƒèƒ½åŠ›å€¼è¨ˆç®—å™¨å·²è¼‰å…¥');
        });
        
        // è¼¸å…¥æ¡†çš„å³æ™‚é©—è­‰
        function setupInputValidation() {
            const statsInputs = ['xBA', 'xSLG', 'xwOBA'];
            const attributeInputs = ['inputPOW', 'inputHIT', 'inputEYE'];
            
            statsInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (value < 0 || value > 1) {
                        this.style.borderColor = '#ff6b6b';
                    } else {
                        this.style.borderColor = '#4ecdc4';
                    }
                });
            });
            
            attributeInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (value < 0 || value > 150) {
                        this.style.borderColor = '#ff6b6b';
                    } else {
                        this.style.borderColor = '#4ecdc4';
                    }
                });
            });
            
            const paInput = document.getElementById('inputPA');
            paInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1 || value > 1000) {
                    this.style.borderColor = '#ff6b6b';
                } else {
                    this.style.borderColor = '#4ecdc4';
                }
            });
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œè¨­ç½®é©—è­‰
        document.addEventListener('DOMContentLoaded', setupInputValidation);
    </script>
</body>
</html>