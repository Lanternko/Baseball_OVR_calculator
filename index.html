<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£’çƒèƒ½åŠ›å€¼é›™å‘è½‰æ›è¨ˆç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
        }
        
        .calculator-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .calculator-section:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
        
        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-top: 10px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #4ecdc4;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: bold;
            color: #555;
        }
        
        .result-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .ovr-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #ffeaa7, #fab1a0);
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .ovr-number {
            font-size: 3em;
            font-weight: bold;
            color: #2d3436;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .ovr-label {
            font-size: 1.2em;
            color: #636e72;
            margin-top: 10px;
        }
        
        .ovr-breakdown {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .icon {
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
        
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¾ æ£’çƒèƒ½åŠ›å€¼é›™å‘è½‰æ›è¨ˆç®—å™¨</h1>
            <p>åŸºæ–¼ POW/HIT/EYE ä¸‰åœç³»çµ±çš„æ£’çƒæ•¸æ“šé æ¸¬å·¥å…·</p>
        </div>
        
        <div class="main-content">
            <!-- æ•¸æ“šè½‰ä¸‰åœ -->
            <div class="calculator-section">
                <h2 class="section-title">
                    <span class="icon">ğŸ“Š</span>
                    æ•¸æ“š â†’ ä¸‰åœ + OVR
                </h2>
                
                <div class="input-group">
                    <label for="xBA">é æœŸæ‰“æ“Šç‡ (xBA)</label>
                    <input type="number" id="xBA" step="0.001" placeholder="ä¾‹å¦‚: 0.280" min="0" max="1">
                    <div class="help-text">é€šå¸¸åœ¨ 0.200 - 0.350 ä¹‹é–“</div>
                </div>
                
                <div class="input-group">
                    <label for="xSLG">é æœŸé•·æ‰“ç‡ (xSLG)</label>
                    <input type="number" id="xSLG" step="0.001" placeholder="ä¾‹å¦‚: 0.450" min="0" max="4">
                    <div class="help-text">é€šå¸¸åœ¨ 0.300 - 0.700 ä¹‹é–“</div>
                </div>
                
                <div class="input-group">
                    <label for="xwOBA">é æœŸåŠ æ¬Šä¸Šå£˜ç‡ (xwOBA)</label>
                    <input type="number" id="xwOBA" step="0.001" placeholder="ä¾‹å¦‚: 0.350" min="0" max="1">
                    <div class="help-text">é€šå¸¸åœ¨ 0.250 - 0.450 ä¹‹é–“</div>
                </div>
                
                <button class="button" onclick="calculateAttributes()">
                    è¨ˆç®—ä¸‰åœ + OVR
                </button>
                
                <div id="attributeResults" class="results" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">ğŸ’ª POW (Power)</span>
                        <span class="result-value" id="powResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ¯ HIT (Hit Tool)</span>
                        <span class="result-value" id="hitResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ‘ï¸ EYE (Plate Discipline)</span>
                        <span class="result-value" id="eyeResult">-</span>
                    </div>
                    
                    <div class="ovr-display">
                        <div class="ovr-number" id="ovrFromStats">-</div>
                        <div class="ovr-label">Overall Rating (OVR)</div>
                        <div class="ovr-breakdown" id="ovrBreakdownStats"></div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸‰åœè½‰æ•¸æ“š -->
            <div class="calculator-section">
                <h2 class="section-title">
                    <span class="icon">âš™ï¸</span>
                    ä¸‰åœ â†’ é æ¸¬æ•¸æ“š
                </h2>
                
                <div class="input-group">
                    <label for="inputPOW">POW (Power)</label>
                    <input type="number" id="inputPOW" placeholder="ä¾‹å¦‚: 85" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputHIT">HIT (Hit Tool)</label>
                    <input type="number" id="inputHIT" placeholder="ä¾‹å¦‚: 75" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputEYE">EYE (Plate Discipline)</label>
                    <input type="number" id="inputEYE" placeholder="ä¾‹å¦‚: 80" min="0" max="150">
                    <div class="help-text">å»ºè­°ç¯„åœ: 30-120</div>
                </div>
                
                <div class="input-group">
                    <label for="inputPA">æ‰“å¸­æ•¸ (PA)</label>
                    <input type="number" id="inputPA" placeholder="ä¾‹å¦‚: 600" min="1" max="1000">
                    <div class="help-text">ä¸€å€‹å®Œæ•´è³½å­£é€šå¸¸ 500-700 æ‰“å¸­</div>
                </div>
                
                <button class="button" onclick="calculateStats()">
                    é æ¸¬æ•¸æ“š + OVR
                </button>
                
                <div id="statsResults" class="results" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">ğŸ“ˆ æ‰“æ“Šç‡ (BA)</span>
                        <span class="result-value" id="baResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸƒ ä¸Šå£˜ç‡ (OBP)</span>
                        <span class="result-value" id="obpResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ’¥ é•·æ‰“ç‡ (SLG)</span>
                        <span class="result-value" id="slgResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ”¥ OPS</span>
                        <span class="result-value" id="opsResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">âš¾ å…¨å£˜æ‰“</span>
                        <span class="result-value" id="hrResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ‘ï¸ ä¿é€ç‡</span>
                        <span class="result-value" id="bbRateResult">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸŒªï¸ ä¸‰æŒ¯ç‡</span>
                        <span class="result-value" id="kRateResult">-</span>
                    </div>
                    
                    <div class="ovr-display">
                        <div class="ovr-number" id="ovrFromAttributes">-</div>
                        <div class="ovr-label">Overall Rating (OVR)</div>
                        <div class="ovr-breakdown" id="ovrBreakdownAttributes"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¸¸æ•¸å®šç¾©
        const LEAGUE_BENCHMARKS = {
            'xBA': {'pr1': 0.200, 'pr50': 0.250, 'pr99': 0.330},
            'xSLG': {'pr1': 0.310, 'pr50': 0.400, 'pr99': 0.640},
            'xwOBA': {'pr1': 0.260, 'pr50': 0.320, 'pr99': 0.430}
        };
        
        const ATTRIBUTE_MAPPING_POINTS = {'pr1': 40, 'pr50': 70, 'pr99': 99};
        const SOFT_CAP_ATTRIBUTE_VALUE = 150.0;
        const ATTR_EFFECT_MIDPOINT = 70.0;
        
        const HR_S_CURVE_POW_ANCHORS = [
            [0, 0.0005], [30, 0.003], [40, 0.0067], [60, 0.020],
            [70, 0.0333], [85, 0.045], [99, 0.0580], [115, 0.072],
            [125, 0.080], [130, 0.0870], [140, 0.098], [150, 0.110]
        ];
        
        const BABIP_S_CURVE_HIT_ANCHORS = [
            [0, 0.215], [30, 0.245], [40, 0.270], [60, 0.295],
            [70, 0.305], [85, 0.330], [99, 0.350], [110, 0.365],
            [120, 0.375], [130, 0.385], [140, 0.395], [150, 0.405]
        ];
        
        const BB_S_CURVE_EYE_ANCHORS = [
            [0, 0.030], [30, 0.045], [40, 0.062], [60, 0.075],
            [70, 0.085], [85, 0.105], [99, 0.125], [115, 0.145],
            [130, 0.160], [140, 0.170], [150, 0.180]
        ];
        
        const K_EYE_EFFECTIVENESS_S_CURVE_ANCHORS = [
            [0, 0.8], [30, 0.5], [40, 0.3], [60, 0.1],
            [70, 0.0], [85, -0.20], [99, -0.40], [115, -0.55],
            [130, -0.70], [140, -0.75], [150, -0.80]
        ];
        
        const AVG_K_RATE_AT_MIDPOINT = 0.220;
        const MIN_K_RATE_CAP = 0.080;
        const MAX_K_RATE_CAP = 0.350;
        const K_RATE_HIT_WEIGHT = 0.50;
        const K_RATE_EYE_WEIGHT = 0.50;
        const K_HIT_EFFECT_MIDPOINT = 70.0;
        const K_HIT_EFFECT_SCALE = 55.0;
        
        const AVG_2B_PER_HIT_BIP_NOT_HR_AT_MIDPOINT = 0.31;
        const MIN_2B_PER_HIT_BIP_NOT_HR = 0.22;
        const MAX_2B_PER_HIT_BIP_NOT_HR = 0.42;
        const EXTRABASE_POW_EFFECT_MIDPOINT = 70.0;
        const EXTRABASE_POW_EFFECT_SCALE = 48.0;
        const EXTRABASE_HIT_EFFECT_MIDPOINT = 70.0;
        const EXTRABASE_HIT_EFFECT_SCALE = 48.0;
        const EXTRABASE_POW_WEIGHT = 0.50;
        const EXTRABASE_HIT_WEIGHT = 0.50;
        
        const LEAGUE_AVG_HBP_RATE = 0.010;
        const NUM_SIMULATIONS = 100; // é™ä½æ¨¡æ“¬æ¬¡æ•¸æå‡æ•ˆèƒ½

        function calculatePlayerGameAttributes(xBA, xSLG, xwOBA) {
            const pr1_map = ATTRIBUTE_MAPPING_POINTS['pr1'];
            const pr50_map = ATTRIBUTE_MAPPING_POINTS['pr50'];
            const pr99_map = ATTRIBUTE_MAPPING_POINTS['pr99'];
            const delta_50_1 = pr50_map - pr1_map;
            const delta_99_50 = pr99_map - pr50_map;
            
            function getAttributeScore(metricVal, pr1Benchmark, pr50Benchmark, pr99Benchmark) {
                let score = 0;
                if (metricVal <= pr1Benchmark) {
                    score = pr1_map;
                } else if (metricVal <= pr50Benchmark) {
                    score = pr1_map + delta_50_1 * (metricVal - pr1Benchmark) / (pr50Benchmark - pr1Benchmark);
                } else if (metricVal <= pr99Benchmark) {
                    score = pr50_map + delta_99_50 * (metricVal - pr50Benchmark) / (pr99Benchmark - pr50Benchmark);
                } else {
                    const slope_pr50_pr99 = delta_99_50 / (pr99Benchmark - pr50Benchmark);
                    score = pr99_map + slope_pr50_pr99 * (metricVal - pr99Benchmark);
                }
                return Math.max(0, score);
            }
            
            return {
                POW: getAttributeScore(xSLG, LEAGUE_BENCHMARKS['xSLG']['pr1'], LEAGUE_BENCHMARKS['xSLG']['pr50'], LEAGUE_BENCHMARKS['xSLG']['pr99']),
                HIT: getAttributeScore(xBA, LEAGUE_BENCHMARKS['xBA']['pr1'], LEAGUE_BENCHMARKS['xBA']['pr50'], LEAGUE_BENCHMARKS['xBA']['pr99']),
                EYE: getAttributeScore(xwOBA, LEAGUE_BENCHMARKS['xwOBA']['pr1'], LEAGUE_BENCHMARKS['xwOBA']['pr50'], LEAGUE_BENCHMARKS['xwOBA']['pr99'])
            };
        }

        function interpolateSCurve(value, anchors) {
            if (!anchors || !anchors.length) return 0.0;
            const cappedValue = Math.min(value, SOFT_CAP_ATTRIBUTE_VALUE * 1.1);
            if (cappedValue <= anchors[0][0]) return anchors[0][1];
            if (cappedValue >= anchors[anchors.length - 1][0]) return anchors[anchors.length - 1][1];
            for (let i = 0; i < anchors.length - 1; i++) {
                const [x1, y1] = anchors[i];
                const [x2, y2] = anchors[i + 1];
                if (x1 <= cappedValue && cappedValue < x2) {
                    return (x2 - x1) ? y1 + (y2 - y1) * (cappedValue - x1) / (x2 - x1) : y1;
                }
            }
            return anchors[anchors.length - 1][1];
        }
        
        function scaleAttributeToEffectiveness(attributeValue, midpoint, scale, effectIsPositive = true) {
            if (scale === 0) return 0.0;
            const normalizedValue = (attributeValue - midpoint) / scale;
            const tanhVal = Math.tanh(normalizedValue);
            return effectIsPositive ? tanhVal : -tanhVal;
        }
        
        function getRateFromEffectiveness(baseRateAtMidpoint, minRate, maxRate, effectivenessFactor) {
            return effectivenessFactor >= 0 ? baseRateAtMidpoint + effectivenessFactor * (maxRate - baseRateAtMidpoint) :
                baseRateAtMidpoint + effectivenessFactor * (baseRateAtMidpoint - minRate);
        }
        
        function calculateHRRateFromPowSCurve(POW) { return interpolateSCurve(POW, HR_S_CURVE_POW_ANCHORS); }
        function calculateBABIPFromHitSCurve(HIT) { return Math.max(0.190, Math.min(0.450, interpolateSCurve(HIT, BABIP_S_CURVE_HIT_ANCHORS))); }
        function calculateBBRateFromEyeSCurve(EYE) { return Math.max(0.020, Math.min(0.250, interpolateSCurve(EYE, BB_S_CURVE_EYE_ANCHORS))); }
        function calculateKRateCombined(EYE, HIT) {
            const eyeKEffectiveness = interpolateSCurve(EYE, K_EYE_EFFECTIVENESS_S_CURVE_ANCHORS);
            const hitKEffectiveness = scaleAttributeToEffectiveness(HIT, K_HIT_EFFECT_MIDPOINT, K_HIT_EFFECT_SCALE, false);
            const combinedKEffectiveness = K_RATE_EYE_WEIGHT * eyeKEffectiveness + K_RATE_HIT_WEIGHT * hitKEffectiveness;
            return Math.max(MIN_K_RATE_CAP, Math.min(MAX_K_RATE_CAP, getRateFromEffectiveness(AVG_K_RATE_AT_MIDPOINT, MIN_K_RATE_CAP, MAX_K_RATE_CAP, combinedKEffectiveness)));
        }
        
        function getPAEventProbabilities(POW, HIT, EYE, playerHBPRate = LEAGUE_AVG_HBP_RATE) {
            const pK = calculateKRateCombined(EYE, HIT);
            const pBB = calculateBBRateFromEyeSCurve(EYE);
            const pHBP = Math.max(0.0, Math.min(0.05, playerHBPRate));
            let pHR = calculateHRRateFromPowSCurve(POW);
            const eyeEffHRMod = scaleAttributeToEffectiveness(EYE, 70.0, 40.0, true);
            const eyeModifier = 1.0 + (eyeEffHRMod * 0.12);
            const hitEffHRMod = scaleAttributeToEffectiveness(HIT, 70.0, 40.0, true);
            const hitModifier = 1.0 + (hitEffHRMod * 0.18);
            pHR = Math.max(0.0, Math.min(pHR * eyeModifier * hitModifier, 0.20));
            const probSumNonBIPPlusHR = pK + pBB + pHBP + pHR;
            let p1B, p2B, pIPO;
            if (probSumNonBIPPlusHR >= 1.0) {
                const scaleDown = 1.0 / probSumNonBIPPlusHR;
                pHR = Math.max(0, 1.0 - (pK * scaleDown + pBB * scaleDown + pHBP * scaleDown));
                p1B = p2B = pIPO = 0.0;
            } else {
                const pBIPForOtherOutcomes = 1.0 - probSumNonBIPPlusHR;
                const pHitGivenBIPRemaining = calculateBABIPFromHitSCurve(HIT);
                const pTotalHitsOnRemainingBIP = pBIPForOtherOutcomes * pHitGivenBIPRemaining;
                pIPO = Math.max(0, pBIPForOtherOutcomes * (1.0 - pHitGivenBIPRemaining));
                if (pTotalHitsOnRemainingBIP > 0) {
                    const powEffXBH = scaleAttributeToEffectiveness(POW, EXTRABASE_POW_EFFECT_MIDPOINT, EXTRABASE_POW_EFFECT_SCALE, true);
                    const hitEffXBH = scaleAttributeToEffectiveness(HIT, EXTRABASE_HIT_EFFECT_MIDPOINT, EXTRABASE_HIT_EFFECT_SCALE, true);
                    const combinedEffXBH = EXTRABASE_POW_WEIGHT * powEffXBH + EXTRABASE_HIT_WEIGHT * hitEffXBH;
                    const p2BGivenHitBIPNotHR = getRateFromEffectiveness(AVG_2B_PER_HIT_BIP_NOT_HR_AT_MIDPOINT, MIN_2B_PER_HIT_BIP_NOT_HR, MAX_2B_PER_HIT_BIP_NOT_HR, combinedEffXBH);
                    p2B = Math.max(0, pTotalHitsOnRemainingBIP * p2BGivenHitBIPNotHR);
                    p1B = Math.max(0, pTotalHitsOnRemainingBIP * (1.0 - p2BGivenHitBIPNotHR));
                } else {
                    p1B = p2B = 0.0;
                }
            }
            return {HR: pHR, '2B': p2B, '1B': p1B, BB: pBB, HBP: pHBP, K: pK, IPO: pIPO};
        }
        
        function simulateSeason(numPA, probabilities) {
            const outcomes = {HR: 0, '2B': 0, '1B': 0, BB: 0, HBP: 0, K: 0, IPO: 0, H: 0, AB: 0, PA: 0, OUT: 0};
            const eventOrder = ['HR', '2B', '1B', 'BB', 'HBP', 'K', 'IPO'];
            for (let i = 0; i < numPA; i++) {
                outcomes.PA += 1;
                const randVal = Math.random();
                let cumulativeProb = 0.0;
                let chosenEvent = 'IPO';
                for (const eventType of eventOrder) {
                    const prob = probabilities[eventType] || 0;
                    cumulativeProb += prob;
                    if (randVal < cumulativeProb) {
                        chosenEvent = eventType;
                        break;
                    }
                }
                outcomes[chosenEvent] += 1;
                if (['HR', '2B', '1B'].includes(chosenEvent)) {
                    outcomes.H += 1;
                    outcomes.AB += 1;
                } else if (['K', 'IPO'].includes(chosenEvent)) {
                    outcomes.OUT += 1;
                    outcomes.AB += 1;
                }
            }
            return outcomes;
        }
        
        function calculateSimStats(simResults) {
            const stats = {};
            const ab = simResults.AB || 0;
            const h = simResults.H || 0;
            const bb = simResults.BB || 0;
            const hbp = simResults.HBP || 0;
            const pa = simResults.PA || 0;
            const k = simResults.K || 0;
            stats.BA = ab > 0 ? h / ab : 0;
            stats.OBP = pa > 0 ? (h + bb + hbp) / pa : 0;
            const tb = (simResults['1B'] || 0) * 1 + (simResults['2B'] || 0) * 2 + (simResults.HR || 0) * 4;
            stats.SLG = ab > 0 ? tb / ab : 0;
            stats.OPS = stats.OBP + stats.SLG;
            stats.K_rate = pa > 0 ? k / pa : 0;
            stats.BB_rate = pa > 0 ? bb / pa : 0;
            stats.HR_count = simResults.HR || 0;
            stats.BB_count = bb;
            stats.K_count = k;
            stats.H_count = h;
            stats.AB_count = ab;
            stats.PA_count = pa;
            return stats;
        }
        
        // ä¿®æ­£çš„ OVR è¨ˆç®—å‡½æ•¸ï¼ˆç§»é™¤ç¡¬ä¸Šé™ï¼Œé™ä½ç²¾è‹±é–€æª»ï¼‰
        function calculateBatterOVR(pow, hit, eye) {
            // ç®—è¡“å¹³å‡ä½œç‚ºåŸºç¤
            const arithmeticMean = (pow + hit + eye) / 3;
            
            // å¹¾ä½•å¹³å‡ (åæ˜ æ•´é«”å¯¦åŠ›ï¼Œé¿å…çŸ­æ¿æ•ˆæ‡‰)
            const geometricMean = Math.pow(pow * hit * eye, 1/3);
            
            // åŸºç¤ OVRï¼šç®—è¡“å¹³å‡ç‚ºä¸»ï¼Œå¹¾ä½•å¹³å‡ç‚ºè¼”
            let baseOVR = arithmeticMean * 0.8 + geometricMean * 0.2;
            
            // === æ›´æ•æ„Ÿçš„ç²¾è‹±çƒå“¡åŠ æˆç³»çµ± ===
            let eliteBonus = 0;
            
            // 1. é™ä½ç²¾è‹±é–€æª»ï¼šå¾ 75 é–‹å§‹æº«å’ŒåŠ æˆ
            if (arithmeticMean > 75) {
                const earlyEliteFactor = Math.min((arithmeticMean - 75) / 10, 1.0); // 75-85çš„é€²åº¦
                eliteBonus += earlyEliteFactor * earlyEliteFactor * 1.5; // æœ€å¤š+1.5åˆ†
            }
            
            // 2. ä¸­æ®µç²¾è‹±åŠ æˆï¼ˆ85-99å€é–“ï¼‰
            if (arithmeticMean > 85) {
                const midEliteFactor = Math.min((arithmeticMean - 85) / 14, 1.0); // 85-99çš„é€²åº¦
                eliteBonus += midEliteFactor * midEliteFactor * 3.5; // æœ€å¤š+3.5åˆ†
            }
            
            // 3. è¶…ç´šç²¾è‹±åŠ æˆï¼ˆ99+å€é–“ï¼Œå°æ•¸å¢é•·ï¼‰
            if (arithmeticMean > 99) {
                const superEliteFactor = arithmeticMean - 99;
                // å°æ•¸å¢é•·ï¼Œä½†ä¿ç•™ç„¡ä¸Šé™ç‰¹æ€§
                eliteBonus += Math.log(1 + superEliteFactor) * 3.0;
            }
            
            // 4. å€‹åˆ¥å±¬æ€§çªç ´çå‹µï¼ˆæ¢å¾©é©ä¸­å¼·åº¦ï¼‰
            let breakthroughBonus = 0;
            [pow, hit, eye].forEach(attr => {
                if (attr > 90) { // é™ä½é–€æª»å¾95åˆ°90
                    breakthroughBonus += (attr - 90) * 0.06;
                }
                if (attr > 105) {
                    breakthroughBonus += (attr - 105) * 0.10;
                }
                if (attr > 120) { // è¶…äººç´šåˆ¥
                    breakthroughBonus += (attr - 120) * 0.15;
                }
            });
            eliteBonus += breakthroughBonus;
            
            // 5. å…¨é¢å„ªç§€çå‹µï¼ˆåŸºæ–¼ç›¸é—œä¿‚æ•¸ç†è«–ï¼‰
            // ç•¶ä¸‰åœéƒ½è¶…éæŸå€‹é–€æª»æ™‚ï¼Œç”±æ–¼æ­£ç›¸é—œæ€§ï¼Œå¯¦éš›ç¨€æœ‰åº¦æ›´é«˜
            const allAboveThresholds = [
                {threshold: 80, bonus: 0.8},  // ä¸‰åœéƒ½>80
                {threshold: 85, bonus: 1.2},  // ä¸‰åœéƒ½>85
                {threshold: 90, bonus: 1.8},  // ä¸‰åœéƒ½>90
                {threshold: 95, bonus: 2.5},  // ä¸‰åœéƒ½>95
                {threshold: 100, bonus: 3.5}, // ä¸‰åœéƒ½>100
                {threshold: 110, bonus: 5.0}  // ä¸‰åœéƒ½>110
            ];
            
            allAboveThresholds.forEach(({threshold, bonus}) => {
                if (pow > threshold && hit > threshold && eye > threshold) {
                    const excessAvg = (pow + hit + eye) / 3 - threshold;
                    eliteBonus += bonus + excessAvg * 0.1; // åŸºç¤çå‹µ+è¶…å‡ºéƒ¨åˆ†
                }
            });
            
            // 6. å‡è¡¡åº¦èª¿æ•´
            const maxAttribute = Math.max(pow, hit, eye);
            const minAttribute = Math.min(pow, hit, eye);
            const balanceRatio = minAttribute / maxAttribute;
            
            // å‡è¡¡çå‹µï¼ˆæ›´æ•æ„Ÿï¼‰
            if (balanceRatio > 0.7 && arithmeticMean > 75) { // é™ä½é–€æª»
                const balanceBonus = (balanceRatio - 0.7) * (arithmeticMean - 75) * 0.05;
                eliteBonus += balanceBonus;
            }
            
            // 7. æ¥µç«¯å°ˆç²¾è£œå„Ÿ
            const hasExtremeTalent = maxAttribute > 95;
            if (hasExtremeTalent && balanceRatio < 0.6) {
                const specializationBonus = (maxAttribute - 95) * 0.08 * (1 - balanceRatio);
                eliteBonus += specializationBonus;
            }
            
            // 8. ç›¸é—œæ€§èª¿æ•´ï¼ˆè¼•å¾®ï¼‰
            const correlationFactor = 0.75;
            const correlationAdjustment = correlationFactor * eliteBonus * 0.12; // é€²ä¸€æ­¥é™ä½
            eliteBonus -= correlationAdjustment;
            
            // 9. å¯¦æˆ°è¡¨ç¾æ¬Šé‡ï¼ˆæº«å’Œï¼‰
            let performanceWeight = 1.0;
            const estimatedOPS = (pow * 0.006 + hit * 0.004 + eye * 0.005) + 0.2;
            
            if (estimatedOPS > 1.200) { // ç¥ç´š OPS
                performanceWeight += (estimatedOPS - 1.200) * 1.0;
            } else if (estimatedOPS > 1.000) { // å‚³å¥‡ç´š OPS
                performanceWeight += (estimatedOPS - 1.000) * 0.6;
            } else if (estimatedOPS > 0.900) { // é ‚å°– OPS
                performanceWeight += (estimatedOPS - 0.900) * 0.4;
            } else if (estimatedOPS > 0.800) { // å„ªç§€ OPS
                performanceWeight += (estimatedOPS - 0.800) * 0.2;
            }
            
            eliteBonus *= performanceWeight;
            
            // === ç§»é™¤ç¡¬ä¸Šé™ï¼Œåƒ…ä¿ç•™è»Ÿä¸Šé™å£“ç¸® ===
            
            // æœ€çµ‚ OVR è¨ˆç®—
            let finalOVR = baseOVR + eliteBonus;
            
            // å¤šå±¤è»Ÿä¸Šé™ï¼Œé€æ¼¸å£“ç¸®ä½†ä¸å°é ‚
            if (finalOVR > 140) {
                finalOVR = 140 + (finalOVR - 140) * 0.2; // 140+ å€é–“å¤§å¹…å£“ç¸®
            } else if (finalOVR > 120) {
                finalOVR = 120 + (finalOVR - 120) * 0.4; // 120-140 å€é–“ä¸­åº¦å£“ç¸®
            } else if (finalOVR > 110) {
                finalOVR = 110 + (finalOVR - 110) * 0.7; // 110-120 å€é–“è¼•åº¦å£“ç¸®
            }
            
            // ç†è«–ä¸Šä¸è¨­ä¸Šé™ï¼Œä½†å¯¦éš›ä¸Šæœƒå› ç‚ºè»Ÿä¸Šé™è€Œå¾ˆé›£è¶…éæŸå€‹å€¼
            finalOVR = Math.max(1, finalOVR);
            
            return {
                ovr: Math.round(finalOVR),
                breakdown: {
                    arithmeticMean: arithmeticMean.toFixed(1),
                    geometricMean: geometricMean.toFixed(1),
                    baseOVR: baseOVR.toFixed(1),
                    eliteBonus: eliteBonus.toFixed(1),
                    balanceRatio: balanceRatio.toFixed(2),
                    performanceWeight: performanceWeight.toFixed(2),
                    estimatedOPS: estimatedOPS.toFixed(3),
                    finalBeforeCap: (baseOVR + eliteBonus).toFixed(1),
                    hasAllAbove80: (pow > 80 && hit > 80 && eye > 80) ? "âœ“" : "âœ—",
                    hasAllAbove90: (pow > 90 && hit > 90 && eye > 90) ? "âœ“" : "âœ—"
                }
            };
        }
        
        function displayOVRBreakdown(breakdown, targetElement) {
            if (!targetElement) return;
            
            const html = `
                <strong>OVR è¨ˆç®—è©³æƒ…ï¼š</strong><br>
                ç®—è¡“å¹³å‡ï¼š${breakdown.arithmeticMean}<br>
                åŸºç¤ OVRï¼š${breakdown.baseOVR}<br>
                ç²¾è‹±åŠ æˆï¼š+${breakdown.eliteBonus} (ç„¡ç¡¬ä¸Šé™)<br>
                åŠ æˆå‰ï¼š${breakdown.finalBeforeCap}<br>
                å‡è¡¡åº¦ï¼š${breakdown.balanceRatio}<br>
                è¡¨ç¾æ¬Šé‡ï¼š${breakdown.performanceWeight}x<br>
                é ä¼° OPSï¼š${breakdown.estimatedOPS}<br>
                å…¨é¢80+ï¼š${breakdown.hasAllAbove80}<br>
                å…¨é¢90+ï¼š${breakdown.hasAllAbove90}
            `;
            
            targetElement.innerHTML = html;
        }
        
        function calculateAttributes() {
            const xBA = parseFloat(document.getElementById('xBA').value);
            const xSLG = parseFloat(document.getElementById('xSLG').value);
            const xwOBA = parseFloat(document.getElementById('xwOBA').value);
            
            if (!xBA || !xSLG || !xwOBA) {
                alert('è«‹å¡«å…¥æ‰€æœ‰æ•¸æ“šï¼');
                return;
            }
            
            if (xBA < 0 || xBA > 1 || xSLG < 0 || xSLG > 4 || xwOBA < 0 || xwOBA > 1) {
                alert('è«‹ç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½åœ¨ 0-1 ä¹‹é–“ï¼');
                return;
            }
            
            const attributes = calculatePlayerGameAttributes(xBA, xSLG, xwOBA);
            const ovrResult = calculateBatterOVR(attributes.POW, attributes.HIT, attributes.EYE);
            
            document.getElementById('powResult').textContent = attributes.POW.toFixed(1);
            document.getElementById('hitResult').textContent = attributes.HIT.toFixed(1);
            document.getElementById('eyeResult').textContent = attributes.EYE.toFixed(1);
            document.getElementById('ovrFromStats').textContent = ovrResult.ovr;
            
            displayOVRBreakdown(ovrResult.breakdown, document.getElementById('ovrBreakdownStats'));
            
            document.getElementById('attributeResults').style.display = 'block';
        }
        
        function calculateStats() {
            const pow = parseFloat(document.getElementById('inputPOW').value);
            const hit = parseFloat(document.getElementById('inputHIT').value);
            const eye = parseFloat(document.getElementById('inputEYE').value);
            const pa = parseInt(document.getElementById('inputPA').value);
            
            if (!pow || !hit || !eye || !pa) {
                alert('è«‹å¡«å…¥æ‰€æœ‰ä¸‰åœå’Œæ‰“å¸­æ•¸ï¼');
                return;
            }
            
            if (pow < 0 || hit < 0 || eye < 0 || pa < 1) {
                alert('è«‹ç¢ºä¿æ‰€æœ‰æ•¸å€¼éƒ½ç‚ºæ­£æ•¸ï¼');
                return;
            }
            
            if (pow > 505 || hit > 342 || eye > 250) {
                alert('ä¸‰åœä¸å¾—è¶…é150ï¼');
                return;
            }
            
            const eventProbs = getPAEventProbabilities(pow, hit, eye);
            
            let totalStats = {BA: 0, OBP: 0, SLG: 0, OPS: 0, K_rate: 0, BB_rate: 0, HR_count: 0};
            for (let i = 0; i < NUM_SIMULATIONS; i++) {
                const seasonResults = simulateSeason(pa, eventProbs);
                const stats = calculateSimStats(seasonResults);
                totalStats.BA += stats.BA;
                totalStats.OBP += stats.OBP;
                totalStats.SLG += stats.SLG;
                totalStats.OPS += stats.OPS;
                totalStats.K_rate += stats.K_rate;
                totalStats.BB_rate += stats.BB_rate;
                totalStats.HR_count += stats.HR_count;
            }
            
            for (let key in totalStats) {
                totalStats[key] /= NUM_SIMULATIONS;
            }
            
            const ovrResult = calculateBatterOVR(pow, hit, eye);
            
            document.getElementById('baResult').textContent = totalStats.BA.toFixed(3);
            document.getElementById('obpResult').textContent = totalStats.OBP.toFixed(3);
            document.getElementById('slgResult').textContent = totalStats.SLG.toFixed(3);
            document.getElementById('opsResult').textContent = totalStats.OPS.toFixed(3);
            document.getElementById('hrResult').textContent = Math.round(totalStats.HR_count);
            document.getElementById('bbRateResult').textContent = (totalStats.BB_rate * 100).toFixed(1) + '%';
            document.getElementById('kRateResult').textContent = (totalStats.K_rate * 100).toFixed(1) + '%';
            document.getElementById('ovrFromAttributes').textContent = ovrResult.ovr;
            
            displayOVRBreakdown(ovrResult.breakdown, document.getElementById('ovrBreakdownAttributes'));
            
            document.getElementById('statsResults').style.display = 'block';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ£’çƒèƒ½åŠ›å€¼è¨ˆç®—å™¨å·²è¼‰å…¥');
            
            // è¨­ç½®è¼¸å…¥é©—è­‰
            ['xBA', 'xSLG', 'xwOBA'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (value < 0 || value > 1) {
                        this.style.borderColor = '#ff6b6b';
                    } else {
                        this.style.borderColor = '#4ecdc4';
                    }
                });
            });
            
            ['inputPOW', 'inputHIT', 'inputEYE'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    if (value < 0 || value > 150) {
                        this.style.borderColor = '#ff6b6b';
                    } else {
                        this.style.borderColor = '#4ecdc4';
                    }
                });
            });
            
            const paInput = document.getElementById('inputPA');
            paInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1 || value > 1000) {
                    this.style.borderColor = '#ff6b6b';
                } else {
                    this.style.borderColor = '#4ecdc4';
                }
            });
        });
    </script>
</body>
</html>